---
title: "Fresno RIPA Data Project"
subtitle: "Descriptive Analysis for Fresno BHC"
author: "Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    toc: yes
    toc_depth: 3
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)


#### Load libraries ####
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
library(flextable)
library(htmlwidgets)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(scales)
library(dplyr)
library(ggplot2)
library(tidytext)


#add function that better fits the tables to the page    
FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

#### Add database connection ####

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("eci_fresno_ripa")

#### Read in tables you need from postgres ####

# You can use the RDA Data Dictionary to look up column meta data for any of these tables. The dictionary is structured the same as pgadmin: https://www.healthycity.org/rda-dev/pgdatadictionary/ 

stops<-dbGetQuery(con, "SELECT * FROM rel_stops")
results<-dbGetQuery(con, "SELECT * FROM rel_stops_result")
person<-dbGetQuery(con, "SELECT * FROM rel_persons")
person_reason<-dbGetQuery(con, "SELECT * FROM rel_persons_reason")
age<-dbGetQuery(con, "SELECT * FROM rel_age")
race<-dbGetQuery(con, "SELECT * FROM rel_races_recode") 
person_result<-dbGetQuery(con, "SELECT * FROM rel_persons_result")
actions<-dbGetQuery(con, "SELECT * FROM rel_stops_actions")
reason<-dbGetQuery(con, "SELECT * FROM rel_stops_reason")
person_action<-dbGetQuery(con, "SELECT * FROM rel_persons_actions")
search<-dbGetQuery(con, "SELECT * FROM rel_stops_searches")

# read in offense codes
offense_codes<-dbGetQuery(con, "SELECT * FROM cadoj_ripa_offense_codes_2023")

pop<-dbGetQuery(con, "SELECT * from population_race_fresno_city")

```

Before engaging in a detailed analysis of the Fresno Police Department's (PD) patrol activity as outlined in the research plan, we created this descriptive analysis to explore overall trends in Fresno PD's RIPA data. This helps us determine if our expected findings are likely to show up in the data and allows us to identify any trends we did not expect. We include basic tallies on each of the following:

* [Overview of officer-initiated stops and calls for service](#overview)
* [Demographics of people stopped by Fresno PD](#demographics)
* [A deep dive into traffic stops](#traffic)
    + [Traffic stops by race and gender](#traffic-demo)
    + [Traffic stops by type](#traffic-type)
    + [Traffic stops by stop reason](#traffic-reason)
    + [Traffic stops by stop result](#traffic-result)
* [Results of officer-initiated stops](#results)
    + [Stops resulting in use of force](#useofforce)
    + [Stops resulting in a field interview (FI) card](#ficard)
    + [Stops resulting in referral to US Department of Homeland Security ICE](#ice)
    + [Stops that resulted in a search that resulted in no contraband](#contraband)
* [Time spent on different types of stops](#time)
    + [Time spent on stops by stop reason](#time-reason)
    + [Time spent on traffic stops by stop result](#time-result)
    + [Time spent on traffic stops by race](#time-race)


# Stops overview {#overview}

## Officer-initiated stops versus calls for service

In 2022, there were a total of 5,317 police stops made by Fresno PD. Of those stops, 5,028 were officer-initiated stops and 289 were calls for service.

In other words, 94.6% of Fresno PD stops were officer-initiated stops while only 5.4% of stops were calls for service.

```{r}
# Use the 'rel_stops' table to calculate the rate and count of officer initiated stops &  calls for service. 

###CALCULATE TOTAL OFFICER INITIATED STOPS##

count_ois <- stops %>%  
  filter(call_for_service == 0) %>% #filters for Officer-Initiated Stops
    select(stop_id) %>% 
       mutate('Total Officer Initiated Stops' = n()) %>%  
         slice(1) %>% 
           select(-stop_id) 

###CALCULATE CALLS FOR SERVICE TOTAL###

count_cfs <- stops %>%
  filter(call_for_service == 1) %>% 
    select(stop_id) %>% 
      mutate('Total Calls for Service' =n()) %>% 
       slice(1) %>% 
           select(-stop_id) 


### CALCULATE THE RATE OF OFFICER INITIATED STOPS AND CALLS FOR SERVICE###

rate_ois <- stops %>%
  group_by(Stop_Type = call_for_service == 0) %>%
    summarise (percent = 100 * n()/ nrow(stops)) %>%
      mutate(percent =round(percent, digits =1),
        Stop_Type = ifelse(Stop_Type, "Officer Initiated Stop", "Calls for Service")) %>%
  rename('Type' = 'Stop_Type')




###BAR CHART to VISUALIZE RATE OF CALLS FOR SERVICE VS OFFICER INITIATED STOP###

rate_ois <- data.frame( #create df to create a visual later
  Type = c("Officer-Initiated Stop", "Calls for Service"),
  percent = c(94.6, 5.4))

ggplot(rate_ois, aes(x = Type, y = percent, fill = Type))+
  geom_bar(stat = "identity") + #to create barplot
  geom_text(aes(label = paste0(round(percent,1), "%")), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size = 3,
          color = "white")+ 
  labs(title = "Nearly 95% of All Stops Fresno PD Makes Are Not Responding to Community Calls", 
       subtitle = "Percentage of stops by stop type in 2022",
       x = "", #labels to visual
       y = "") +
  scale_fill_manual(values = c("Officer-Initiated Stop"="#362178",
      "Calls for Service" = "#362178" ))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())


```


## People stopped for officer-initiated stops

In 2022, Fresno PD stopped a total of 5,365 people. Of these people, 94.3% of them, or 5,060 people, were stopped through officer-initiated stops.

```{r}

# Use the 'rel_persons' AND 'rel_stops' table to calculate total number of people stopped for officer-initiated stops


tot_cfs_ois <- left_join(stops, person, by ="stop_id")%>%
  mutate(total=n())%>%
  group_by(call_for_service)%>%  
    summarise(count=n(),
              percent=count/min(total)*100,
              total=min(total))

```


# Demographics {#demographics}

## Fresno City population demographics

The majority of people living in Fresno City are Latinx. Additionally, one in four people in Fresno are White. RIPA and census data often group all Asian subgroups into a larger ‘Asian’ category. However, there is also a diverse Asian community in Fresno. The largest Asian subgroup in Fresno is Hmong followed by Filipino. Asian Indians also make up one of the largest Asian groups though in RIPA data, South Asians are grouped with SWANA.

```{r}
# create ggplot graph of race population in Fresno

# mutate race labels for graph

df <- pop %>%
  mutate(Race = case_when(
    race == 'latinx' ~ "Latinx", 
    race =='nh_white' ~ 'White',
    race =='nh_black' ~ 'Black',
    race == 'aian' ~ 'AIAN',
    race == 'nhpi' ~ 'NHPI',
    race == 'nh_twoormor' ~ 'Multiracial',
     race == 'sswana' ~ 'SWANA/SA', 
    race=='nh_asian_wo_sa' ~ 'Asian',
    TRUE ~ as.character(race)))%>%
  filter(grepl("Latinx|White|Black|Asian|AIAN|NHPI|SWANA/SA|Multiracial", Race))%>%
  mutate(rate=rate*100)
    

#graph

ggplot(df, aes(x = reorder(Race, rate), y = rate))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(rate,1), "%")), #add percentage labels within the bars
          vjust=.5, #center percentage within the bar
          hjust=0,
          size = 3,
          color = "black")+ 
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 5))+
  labs(title = "Half of the People Living in Fresno City are Latinx", 
       subtitle = "Population in Fresno City by race",
       caption = str_wrap("Race note: AIAN=American Indican or Alaska Native; NHPI = Native Hawaiian or Pacific Islander; SWANA/SA=Southwest Asian and North African / South Asian; Asian excludes South Asian",110),
       x = "", #labels to visual
       y = "") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5),
       plot.caption = element_text(hjust = 0))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
  coord_flip()


```


## Perceived race of people stopped

Over half of the people Fresno PD stopped were people they perceived as Latinx. For reference, about 50.5% of Fresno City's total population is Latinx. As a comparison, 11.3% of people that Fresno PD stopped were people officers perceived as Black, while only 6.2% of Fresno City's total population is Black.

```{r}

# Calculate the count and rate of officer-initiated stops by perceived race of person stopped. Use the 'rel_races_recode' table & 'rel_stops'

##CALCULATES COUNT AND RATE FOR OIS BY RACE##

df_race <-  left_join(stops, race, by ="stop_id")%>% #joining tables 
  filter(call_for_service ==0)


df_nh <- df_race %>% ##creates df for nh_race
  select(nh_race)%>% 
  mutate(Total=n())%>%
  group_by(nh_race)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)

df_sswana <- df_race %>% #creates df for sswana
  mutate(Total=n())%>%
  group_by(sswana_flag)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)%>%
  ungroup()%>%
  select(sswana_label, Total, Count, Percent)%>%
    rename(nh_race=sswana_label)

df_nhpi <- df_race %>% #creates df for nhpi
  mutate(Total=n())%>%
  group_by(nhpi_flag)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)%>%
  ungroup()%>%
  select(nhpi_label, Total, Count, Percent)%>%
    rename(nh_race=nhpi_label)

df_aian <- df_race %>% #creates df for aian
  mutate(Total=n())%>%
  group_by(aian_flag)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)%>%
  ungroup()%>%
  select(aian_label, Total, Count, Percent)%>%
  rename(nh_race=aian_label)
  
final_race <- rbind(df_nh%>%filter(!nh_race %in% c("nh_aian","nh_sswana","nh_nhpi")), 
                    df_sswana%>%filter(nh_race=='sswana'),
                    df_aian%>%filter(nh_race=='aian'),
                    df_nhpi%>%filter(nh_race=='nhpi')) ##combines nh_race and sswana, nhpi, aian

qa<-df_race%>%group_by(nh_race,sswana_flag, aian_flag,nhpi_flag)%>%summarise(count=n())

## Recode for nh_race for visual labels

final_race <- final_race %>%
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'aian' ~ 'AIAN',
    nh_race == 'nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))
    
##ADDING TOTAL NUMBER TO LABEL##

final_race <- final_race%>%
  mutate(label = paste0("Total: ", Count, "\n", round(Percent, 1),"%"))

##VISUALIZATION FOR RATE OF OIS BY RACE ##

ggplot(final_race, aes(x = reorder(Race, -Percent), y = Percent, fill = Race))+
  geom_bar(stat = "identity") + #to create barplot
  geom_text(aes(label = label), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size =3,
          color = "white")+ 
  labs(title = "Latinx Individuals Make Up Half of Officer-Initiated Stops by Fresno PD",
       subtitle = "Percentage of people stopped during officer-initiated stops by perceived race",
       x = "",
       y = "") +
  scale_fill_manual(values = c("#362178", "#362178", "#362178", "#362178", "#362178", "#362178", "#362178","#362178"))+
  theme_bw()+
  theme(plot.title = element_text(hjust =0.5),
        plot.subtitle = element_text(hjust =0.5),
 #sets y-axis labels to be horizontal
      legend.position ="none", #removes legend
      axis.text.y = element_text(angle =0, hjust=1), #Makes y-axis text readable
      axis.text.x = element_text(angle =0, hjust=0.5)) +
  theme(axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())
#Makes x-axis text readable

```


## Perceived age of people stopped 

Individuals aged 25-34 experienced the highest numbers of officer-initiated stops by Fresno PD in the year 2022.

```{r}

# Calculate the count and rate of officer-initiated stops by age-brackets of person stopped. Use the 'rel_age' table & 'rel_stops'

age_ois<- left_join(age, stops, by ="stop_id")%>% #Joined tables
  filter(call_for_service ==0)%>% #Filtered for OIS
  select(age_group_re)%>% # Selected table of interest
  mutate(Total=n())%>% #To find total number for OIS 
  group_by(age_group_re)%>% # Grouping by recoded age brackets
  mutate(Count=n(), 
         Percent = round(Count/Total*100, 1))%>% #Create percentages and rounding them to tenths place
  slice(1)%>%
  rename('Age' ='age_group_re')%>%
  arrange(-Percent)

#########VISUALIZATION FOR RATE OF OIS BY AGE GROUP########

ggplot(age_ois, aes(x = Age, y=Percent))+
      geom_bar( stat = "identity", fill="#362178") + #create barchart 
  geom_text(aes( label = paste0(round(Percent, digits=1),"%" ), #round to tenths place within barchart label
                 y= Percent),
            vjust = 1.4, 
            size =3,
            color = "white",
             fontface = "bold")+
    labs(title = "People Ages 25-34 Account for Nearly 35% of Officer-Initiated Stops by Fresno PD",
         subtitle= "Percentage of people stopped during officer-initiated stops by perceived age",
      x = "", #labels
  y = "")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
    theme(plot.title = element_text(hjust =0.5),
          plot.subtitle = element_text(hjust=0.5),
  axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=10), #for label and axis settings
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())


```


## Perceived gender of people stopped 

In 2022, people perceived by Fresno PD as men (cisgender males) accounted for nearly 57% of all officer-initiated stops.

```{r}

# Calculate people stopped for officer-initiated stop by perceived gender. Use the table 'rel_persons' & 'rel_stops'

  gender_ois<- left_join(person, stops, by ="stop_id")%>% 
  filter(call_for_service ==0)%>%
  select(g_full)%>% 
  mutate(Total=n())%>%
  group_by(g_full)%>%
  mutate(Count=n(), 
         Percent = round(Count/Total*100, 1))%>%
  slice(1)%>%
  arrange(-Percent)

##RECODING FOR GENDER SO THAT X-AXIS DISPLAYS GENDERS INSTEAD OF 1:5##

gender_ois <- gender_ois %>%
  mutate(Gender = recode(g_full,
                         '1'= 'Male',
                         '2' = 'Female',
                         '3' = "Transgender Man/Boy",
                         '4' = 'Transgender Woman/Girl',
                         '5' = 'Gender Nonconforming'))


#########VISUALIZATION FOR OIS BY PERCEIVED GENDER########

ggplot(gender_ois, aes(x= reorder(Gender, -Percent), y= Percent, fill = Gender))+
      geom_bar( stat = "identity", fill="#362178") + #create barchart 
  geom_text(aes(label = paste0(round(Percent, digits=1),"%"), #round to tenths place within barchart label
                 y= Percent),
            vjust = 1.4, 
            size =3,
            color = "white",
             fontface = "bold")+
    labs(title = "Males Account for Nearly 57% of Officer-Initiated Stops",
         subtitle = "Officer-initiated stops by perceived gender in 2022",
      x = "", #labels
  y = "")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
  theme(plot.title = element_text(hjust =0.5),
         plot.subtitle = element_text(hjust=0.5),
  axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=8), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())

```


## Perceived race and age group

In all age groups under 55 years old, individuals Fresno PD perceived as Latinx made up nearly 50% or more of total officer-initiated stops. For reference, 50.5% of the total population in Fresno City is Latinx. By comparison, 6.2% of the total population in Fresno City is Black, and 6.1% of the total population is SWANA/SA. In most age groups, individuals perceived by Fresno PD as Black made up a higher percent of Fresno PD's officer-initiated stops, exceeding their proportion relative to Fresno's general population.

In 2022, individuals perceived as White within the age groups of 55-64 and 65 and older were the most frequently stopped during officer-initiated stops. White individuals may make up a higher share of the total population in these age groups in Fresno. White individuals make up 25.4% of Freno City's population.

```{r, fig.width=9, fig.height=9}

race_age_ois <- left_join(age, stops, by ="stop_id")%>% 
  left_join(race, by =c("stop_id","person_number"))%>%
  left_join(person%>%mutate(person_number=as.character(person_number)),by =c("stop_id","person_number"))

race_age_ois<-race_age_ois%>%
  filter(call_for_service ==0)%>% #Filtered for OIS
  group_by(age_group_re)%>%
  mutate(total_age=n())%>% #To find total number for each age group
  group_by(age_group_re,nh_race,total_age)%>% # Grouping by all 3 variables and keeping the total per age group recoded
  summarise(Count=n(), # count for the age/race combo
         Percent = round(Count/total_age*100, 1))%>% # percentage for the race combo out of the age category
  slice(1)

##Clean to make Flextable##


race_age_ois <- race_age_ois%>% #Rename column
  rename('Age Group' = age_group_re, 'Total' = total_age)



race_age_ois <- race_age_ois %>% #Recode for race
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
      nh_race == 'nh_sswana' ~ 'SWANA/SA'))

####Deleting nh_race columns to make a cleaner flextable####
race_age_ois <- race_age_ois[, !names(race_age_ois) %in% c("nh_race")]

#####Reordering columns#####
race_age_ois <- race_age_ois %>% 
  select(`Age Group`, Race, everything())

# ##Flextable for Age Group, Race##
#   flextable(race_age_ois) %>% 
#   set_caption('Officer-Initiated Stops in 2022 by Race and Age') %>% 
#   theme_vanilla() %>%
#   width(width=2,unit="in")
  
  ##Visualization for distribution##
ggplot(race_age_ois, aes(x = Race, y = Percent))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(Percent,1), "%"),y=Percent+5), #add percentage labels within the bars
          position = position_dodge(2), #center percentage within the bar
          # vjust = "outward",
          size = 3)+
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 10))+
  labs(title = "Latinx People Make Up Most Stops by Age, but Black People are Overrepresented", 
       subtitle = "Officer-initiated Stops in 2022 by race and age",
       x = "", #labels to visual
       y = "Percent of Age Group") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=8), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
     facet_wrap(. ~ `Age Group`,nrow=4,scales='free_x')

```


## Perceived age by race and gender

In 2022, people perceived as men (cisgender males) were the most frequently stopped group across most age and race combinations. Latinx men ages 18-34, followed by Latinx women ages 25-34, had the highest number of stops by Fresno PD during officer-initiated stops.

In 2022, Latinx men ages 17 and under comprised more than 40% of people stopped under the age of 17. Similarly, Latinx men ages 18-24 made up about 37% of people stopped between the ages of 18-24.

```{r, fig.width=9, fig.height=9}

# Calculate the distribution of perceived gender/age of people stopped within each perceived racial group. 

age_race_gender_ois<- left_join(age, stops, by ="stop_id")%>% 
  left_join(race, by =c("stop_id","person_number"))%>%
  left_join(person%>%mutate(person_number=as.character(person_number)),by =c("stop_id","person_number"))

age_race_gender_ois_table<-age_race_gender_ois%>%
  filter(call_for_service ==0)%>% #Filtered for OIS
  group_by(age_group_re)%>%
  mutate(total_age=n())%>% #To find total number for each age group
  group_by(age_group_re,nh_race,g_full,total_age)%>% # Grouping by all 3 variables and keeping the total per age group recoded
  summarise(Count=n(), # count for the age/race/gender combo
         Percent = round(Count/total_age*100, 1))%>% # percentage for the race/gender combo out of the age category
  slice(1)

 ##Clean to make Flextable##

age_race_gender_ois_table <- age_race_gender_ois_table %>% #Recode for Race#
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
      nh_race == 'nh_sswana' ~ 'SSWANA'))


age_race_gender_ois_table <- age_race_gender_ois_table %>% ##Recode for Gender##
  mutate(Gender = recode(g_full,
                         '1'= 'Male',
                         '2' = 'Female',
                         '3' = "Transgender Man/Boy",
                         '4' = 'Transgender Woman/Girl',
                         '5' = 'Gender Nonconforming'))


age_race_gender_ois_table <- age_race_gender_ois_table%>% ###Renaming columns### 
  rename('Age Group' = age_group_re, 'Total' = total_age )


####Deleting nh_race and  g_full columns to make a cleaner flextable####
age_race_gender_ois_table <- age_race_gender_ois_table[, !names(age_race_gender_ois_table) %in% c("nh_race", "g_full")]

# add percent out of race and age
age_race_gender_ois_table<-age_race_gender_ois_table%>%
  group_by(`Age Group`,Race)%>%
  mutate(total_race=sum(Count))%>%
  ungroup%>%
  mutate(percent_race=Count/total_race*100)

#####Reordering columns#####
age_race_gender_ois_table <- age_race_gender_ois_table%>% 
  select(`Age Group`, Race, Gender, everything())%>%
  filter(Gender=='Male' | Gender=='Female')

# ##Flextable for Age Group, Race, and Gender##
#   flextable(age_race_gender_ois_table) %>% 
#   set_caption('Officer-Initiated Stops Over Time by Age Group, Race, and Gender') %>% 
#   theme_vanilla() %>%
#   width(width=2,unit="in")

ggplot(age_race_gender_ois_table, aes(x = Race, y = Percent,fill=Gender))+
  geom_bar(stat = "identity"
           ) + 
   scale_fill_manual(values = c("#CEC4E2","#362178"))+#to create barplot
  # geom_text(aes(label = paste0(round(Percent,1), "%"),y=Percent+5), #add percentage labels within the bars
  #         # position = position_dodge(2), #center percentage within the bar
  #         # vjust = "outward",
  #         size = 3)+
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 10))+
  labs(title = "Men Account for Most Stops Across Age and Race Groups", 
       subtitle = "Officer-initiated stops in 2022 by age, race, and gender",
       x = "", #labels to visual
       y = "Percent of Age Group") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=0.5, size=6), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
     facet_wrap(. ~ `Age Group`,nrow=4,scales='free')    

```


# Stop Reasons

The following explores the most common reasons for officer-initiated stops in 2022. Traffic violations are the overwhelming majority of officer-initiated stops that Fresno PD made in 2022, exceeding more than what is seen in other police jurisdictions in California. For this reason, we explore [traffic stops](#traffic) more in depth as its own section. 


## Officer-initiated stops by stop reason

Fresno PD makes an overwhelming majority of their officer-initiated stops for traffic violations. In 2022, Over 99% of people stopped by Fresno PD officers were stopped due to a perceived traffic violation.

```{r}

# Total count and rates of officer-initiated stops by stop reason. Use officer-initiated stops is the denominator. For this use tables: rel_stops & rel_stops_reason 

# Feel free to visualize as a bar graph, table, or whatever you think works best!

##Create df of all officer-initiated stops w/ stop reason variables##
ois_reason <- left_join(stops, person_reason, by ="stop_id")%>%
  filter(call_for_service ==0) %>%
  select(stop_id, reason, everything())

##Create df with rates and counts by stop reason##
count_ois_reason <- ois_reason %>%
  group_by(reason) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
    arrange(desc(Count)) %>%               # Change column names and value                                                 displays for more legible table
  rename('Reported Stop Reason' = reason, 
         '# of People Stopped' = Count, 
         '% of All People Stopped' = Percent) %>%
     mutate(`% of All People Stopped` = sprintf("%.2f%%", `% of All People Stopped`))

##Flextable for counts and rates of stop reasons##
  flextable(count_ois_reason) %>% 
  set_caption('Reasons for Officer-Initiated Stops by Fresno PD') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header")
```

# Traffic Stops {#traffic}

This section dives deeper into officer-initiated traffic stops made by Fresno PD in 2022, given that traffic stops make up the overwhelming majority of all stops that Fresno PD made in that year. 

## Traffic stops by race and gender {#traffic-demo}

People perceived as Black by Fresno PD are stopped for traffic stops at disproportionately high rates relative to the total Black population in Fresno city. 

```{r}

# JZ code chunk for prep

### Create traffic violation universe at person level

traffic<-person%>%
  mutate(person_number=as.character(person_number))%>%
  left_join(stops)%>%
  left_join(person_reason, by =c("stop_id","person_number"))%>%
  filter(call_for_service==0 & reason=='Traffic violation')%>% # keep only officer-initiated stops and traffic violations
  select(stop_id, person_number, reason, g_full, reason, traffic_violation_type, rfs_traffic_violation_type.x, rfs_traffic_violation_code.x )
 
# remove the .x from colunm names

names(traffic) <- gsub(x = names(traffic), pattern = "\\.x", replacement = "")  

```


```{r}

# join race data to traffic-person level table

df<-traffic%>%
  left_join(race)
  
# Analyze and visualize race only cut ----------------------

df_race<-df%>%
  mutate(total=n())%>%
  group_by(nh_race)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
 ungroup()%>%
    mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'nh_sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))%>%
   select(Race, total, count,rate)%>%
arrange(-rate)

# graph

ggplot(df_race, aes(x = reorder(Race, rate), y = rate))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(rate,1), "%")), #add percentage labels within the bars
       vjust=1, hjust=-0.1, #center percentage within the bar
          size = 3,
          color = "black")+ 
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 5))+
  labs(title = str_wrap("Half of the People Fresno PD Stops for Traffic Stops are People Perceived as Latinx", 55), 
       subtitle = "Perceived race of people stopped for traffic stops by Fresno PD",
       x = "", #labels to visual
       y = "") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+ 
  coord_flip()


```

Within traffic stops of each perceived racial group, those who Fresno PD perceived as male are stopped at higher rates than those Fresno PD perceived as female across all BIPOC groups. The gender disparity in traffic stops is highest for individuals perceived SWANA/SA, with individuals perceived as male and SWANA/SA being stopped a much higher rate than individuals perceived as female and SWANA/SA. 

Note that the graph below filters for perceived racial groups that had 10 or more people stopped in traffic stops, and perceived gender groups that had at least a 1% rate for officer-initiated traffic stops in 2022. 

```{r}

    
#  Analyze and visualize race+gender cut-----------------------------

gender<-df%>%
    group_by(nh_race)%>%
  mutate(total=n())%>%
  group_by(nh_race, g_full)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
     mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'nh_sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))%>%
    mutate(Gender = recode(g_full,
                         '1'= 'Male',
                         '2' = 'Female',
                         '3' = "Transgender Man/Boy",
                         '4' = 'Transgender Woman/Girl',
                         '5' = 'Gender Nonconforming'))%>%
  select(Race, Gender, total, count,rate)%>%
  arrange(Race, Gender, -rate)%>%
  filter(total>=10 & rate >=1)


# graph

ggplot(gender, aes(x = Gender, y = rate))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(rate,1), "%")), #add percentage labels within the bars
          position = position_stack(vjust=1.2), #center percentage within the bar
          size = 3,
          color = "black")+
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 5))+
  labs(title = "Fresno PD Disproportionately Stops SWANA/SA Men in Traffic Stops",
       subtitle = "Perceived race and gender of people stopped in traffic stops by Fresno PD",
       x = "", #labels to visual
       y = "") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.7, hjust=1, size=7), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=7, face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
  facet_wrap(~Race, ncol=4, scales="free")


```

## Traffic stops by type {#traffic-type}

Fresno PD made close to 4,000 traffic stops of moving vehicles in 2022, which represented more than three-quarters of their total stops for traffic violations. That means the remaining 25% of all traffic stops were made for equipment and non-moving traffic stops. Of the other quarter of vehicles that were stopped, 15% were stopped for equipment violations, while 8% were stopped for non-moving violations.

```{r}

# Total count and rates of traffic stops by each traffic stop type: 1 Moving; 2 Equipment; 3 Nonmoving; Blank. 

#Denominator is out of all officer-initiated traffic stops. 

##Filter out non-traffic violation stops##
tv_reason <- ois_reason %>%
  filter(reason == "Traffic violation")

count_tv_reason <- tv_reason %>%
group_by(traffic_violation_type) %>%
summarise(Count = n(), .groups = 'drop') %>%
mutate(Percent = Count/sum(Count) * 100)

##Create df with count and rates for different traffic stop types##
count_tv_reason <- tv_reason %>%
group_by(traffic_violation_type) %>%
summarise(Count = n(), .groups = 'drop') %>%
mutate(Percent = Count/sum(Count) * 100)

##Create bar chart to visualize counts and rates##
ggplot(count_tv_reason, aes(x = traffic_violation_type, y = Percent, fill = traffic_violation_type)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_manual(values = c("#362178", "#362178", "#362178")) +
  geom_text(aes(label = paste0(Count," people (",round(Percent,1),'%)')),
    vjust = 1.2, color = "white", size = 4) +
  labs(
    title="The Majority of Traffic Stops made by Fresno PD are Moving Stops",
    subtitle = "Fresno PD traffic violation stops by type",
    x = "Traffic Violation Type",
    y = "% of All People Stopped for Traffic Violations") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust=0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 2,
                               size = 12,
                               margin = margin(t = 2)),
     axis.text.y = element_text(size = 12),
    legend.position = "none",
    panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank()) +
  scale_y_continuous(limits = c(0, 100))

```

## Traffic stops by stop reason {.tabset}

The analyses below show the top stop reasons for each of the three different types of traffic stops: equipment traffic stops, non-moving traffic stops, and moving traffic stops.

```{r}

# This can be a table looking at the top 50 citations within non-moving/equipment traffic stop types. Denominator is non-moving/equipment traffic stops

# Use table 'rel_persons_reason' and the column 'rfs_traffic_violation_code.' You can look up the citation codes here: "W:\Project\ECI\Fresno RIPA\Data\sdcs-look-up-table-2023.v2.xlsx"  

##Filter out moving traffic stops from data set##
tv_nonmove_reason <- tv_reason %>%
  filter(traffic_violation_type != "Moving")

##Create data frame with counts/rates for most frequent citations##
tv_citation_count <- tv_nonmove_reason %>% 
  group_by(rfs_traffic_violation_code) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
  arrange(desc(Count))

##Create data frame for table visualization with top 10 citations##
# tv_citation_flex <- tv_citation_count[1:10, ] %>%
#   mutate('Traffic Violation' = case_when(
#     rfs_traffic_violation_code == "54571" ~ "Obstructed window/mirrors", 
#     rfs_traffic_violation_code == "54657" ~ "Unregistered vehicle",
#     rfs_traffic_violation_code == "54644" ~ "License plates improperly displayed",
#     rfs_traffic_violation_code == "54099" ~ "Unregistered vehicle in public parking facility",
#     rfs_traffic_violation_code == "54109" ~ "Improper vehicle lighting",
#     rfs_traffic_violation_code == "54168" ~ "Expired registration",
#     rfs_traffic_violation_code == "54116" ~ "Inadequate mufflers",
#     rfs_traffic_violation_code == "54141" ~ "Improper bicycle lighting",
#     rfs_traffic_violation_code == "54110" ~ "License plate not illuminated",
#     rfs_traffic_violation_code == "54191" ~ "Driving without headlights",)) %>% #Adding descriptions of violation indicated by citation code 
#   select(rfs_traffic_violation_code, 'Traffic Violation', Count, Percent) %>% #Re-ordering columns
#   rename(
#     `% of Total Equipment/Non-moving Traffic Stops` = Percent,
#     `# of Times Recorded` = Count) %>% # Renaming columns to serve as better table headers
#   mutate(`% of Total Equipment/Non-moving Traffic Stops` = sprintf("%.2f%%", `% of Total Equipment/Non-moving Traffic Stops`)) %>% #Improving display of percentages for table
#   select(2:4) # Hiding citation codes for table
#   
# ##Create Flex table##
#   flextable(tv_citation_flex) %>% 
#   set_caption('Reasons for Equipment and Non-moving Traffic Stops by Fresno PD (2022)') %>% 
#   theme_vanilla() %>%
#   width(width=2,unit="in") %>%
#     align(j = 3, align = "right", part = "body") %>%
#     align(j = 3, align = "right", part = "header")
#   

```

### Equipment traffic stop reasons {#traffic-reason}

The table below shows the ten most common stop reasons for equipment traffic stops.

```{r}
##Filter all non-Equipment traffic stops from data set##
tv_equip_reason <- tv_reason %>%
  filter(traffic_violation_type == "Equipment")

##Create data frame with counts/rates for most frequent stop reasons and join data with offense code data to add statute description##
tv_equip_count <- tv_equip_reason %>% 
  group_by(rfs_traffic_violation_code) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
  arrange(desc(Count)) %>%
  left_join(offense_codes, by =c("rfs_traffic_violation_code" = "offense_code")) %>%
  select(rfs_traffic_violation_code, statute_literal_25, Count, Percent, everything())

##Create df for table visualization of top 10 stop reasons##
tv_equip_flex <- tv_equip_count[1:10, ] %>%
  rename(
    `% of Total Equipment Traffic Stops` = Percent,
    `# of Times Recorded` = Count,
    `Traffic Violation` = statute_literal_25) %>% # Renaming columns to serve as better table headers
  mutate(`% of Total Equipment Traffic Stops` = sprintf("%.2f%%", `% of Total Equipment Traffic Stops`)) %>% #Improving display of percentages for table
  select(2:4) # Selecting columns to appear in table

##Create Flextable##
flextable(tv_equip_flex) %>% 
  set_caption('Reasons for Equipment Traffic Stops by Fresno PD (2022)') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header")

```

### Non-moving traffic stop reasons

There are heavy inconsistencies in Fresno PD's classification of traffic stops as "non-moving." Of the 10 most common offenses reported as reasons for non-moving traffic stops, six of them also appear in the 10 most common reasons for equipment-related stops, while two also appear in the list of most common reasons for moving stops.

```{r}
##Filter TV to only included non-moving stops##
tv_NMonly_reason <- tv_reason %>%
  filter(traffic_violation_type == "Non-moving")

##Create data frame with counts/rates for most frequent stop reasons and join data with offense code data to add statute description##
tv_NMonly_count <- tv_NMonly_reason %>% 
  group_by(rfs_traffic_violation_code) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
  arrange(desc(Count)) %>%
  left_join(offense_codes, by =c("rfs_traffic_violation_code" = "offense_code")) %>%
  select(rfs_traffic_violation_code, statute_literal_25, Count, Percent, everything())

##Create df for table visualization of top 10 stop reasons##
tv_NMonly_flex <- tv_NMonly_count[1:10, ] %>%
  rename(
    `% of Total Non-moving Traffic Stops` = Percent,
    `# of Times Recorded` = Count,
    `Traffic Violation` = statute_literal_25) %>% # Renaming columns to serve as better table headers
  mutate(`% of Total Non-moving Traffic Stops` = sprintf("%.2f%%", `% of Total Non-moving Traffic Stops`)) %>% #Improving display of percentages for table
  select(2:4) # Selecting columns to appear in table

##Create Flextable##
flextable(tv_NMonly_flex) %>% 
  set_caption('Reasons for Non-moving Traffic Stops by Fresno PD (2022)') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header")

```

### Moving traffic stop reasons

Of the 3,876 moving vehicles stopped for suspected traffic violations by Fresno PD in 2022, over three-quarters were stopped for speeding.

```{r}
##Filter TV data to only include moving stops##
tv_move_reason <- tv_reason %>%
  filter(traffic_violation_type == "Moving")

##Create data frame with counts/rates for most frequent stop reasons##
tv_move_count <- tv_move_reason %>% 
  group_by(rfs_traffic_violation_code) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
  arrange(desc(Count)) %>%
  left_join(offense_codes, by =c("rfs_traffic_violation_code" = "offense_code")) %>%
  select(rfs_traffic_violation_code, statute_literal_25, Count, Percent, everything())

##Create df for table visualization of top 10 stop reasons##
tv_move_flex <- tv_move_count[1:10, ] %>%
  rename(
    `% of Total Moving Traffic Stops` = Percent,
    `# of Times Recorded` = Count,
    `Traffic Violation` = statute_literal_25) %>% # Renaming columns to serve as better table headers
  mutate(`% of Total Moving Traffic Stops` = sprintf("%.2f%%", `% of Total Moving Traffic Stops`)) %>% #Improving display of percentages for table
  select(2:4) # Selecting columns to appear in table

##Create Flextable##
flextable(tv_move_flex) %>% 
  set_caption('Reasons for Moving Traffic Stops by Fresno PD (2022)') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header")

```
 
## Traffic stop reasons by race

Within traffic stops that were made by Fresno PD, the most common cited reason is driving at an unsafe speed. However,  people perceived as Asian or Black are stopped in traffic stops for a reason of 'No vehicle registration' at higher rates compared to other groups. People perceived as Latinx were stopped because of an obstruction in vehicle window at higher rates than other groups. Traffic stops made for reasons such as vehicle registration do not advance public safety. Traffic stops made for these type of reasons may indicate that profiling is occurring.

Note that the graphs below filter out perceived racial groups where less than 10 people were stopped in traffic stops by Fresno PD in 2022. 

```{r,,  fig.width=9, fig.height=9}

df0<-traffic%>%
  left_join(race)%>%
  left_join(offense_codes, by=c("rfs_traffic_violation_code"="offense_code"))%>%
  group_by(nh_race)%>%
  mutate(total=n())%>%
  group_by(statute_literal_25, offense_type_of_charge, nh_race)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
   mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'nh_sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))%>%
  ungroup()%>%
  select(Race, statute_literal_25, total, count, rate)%>%
  group_by(Race)%>%
    arrange(Race, -count)%>%
   slice(1:3)%>%
  filter(total>=10) ### Filter total number of people to be a least 10
  
## ggplot-----------
df0$statute_literal_25 = str_wrap(df0$statute_literal_25, width = 3)

ggplot(df0, aes(x = reorder_within(statute_literal_25, -rate, Race), y = rate))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(rate,1), "%")), #add percentage labels within the bars
          vjust=-.5, #center percentage within the bar
          size = 3,
          color = "black")+ 
  scale_x_discrete(labels = function(x) str_wrap(x,width=3))+
  labs(title=str_wrap("Two of the top reasons officers use to stop Black and Latinx people do not advance traffic safety",70),
    subtitle = str_wrap("Top traffic citation reasons by perceived race of person stopped",110), 
       x = "", #labels to visual
       y = "") +
  theme_bw()+
  theme(
    # axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      # legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5,size=16),
      plot.subtitle = element_text(hjust=0.5,size=14))+
  theme(axis.text.x = element_text(vjust = 0.5, hjust=0.5, size=6), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
  facet_wrap(. ~ Race, ncol=3, scales = 'free_x') +
  scale_x_reordered()

```

### Traffic stops made for driving without license citation

The Fresno PD only stopped 9 people in 2022 for the original reason of driving without a license.

```{r}

# Calculate count of traffic stops that result with a citation for driving without a license. You can look up the citation codes here: "W:\Project\ECI\Fresno RIPA\Data\sdcs-look-up-table-2023.v2.xlsx"

##Get count for how many citations there were for driving w/o license##
noDL_count <- tv_reason %>%
  filter(                         #All citation codes for driving w/o license, using statute VC 12500 (a-d) and VC 1291(a-b)
    rfs_traffic_violation_code %in% c(42127, 54107, 54140, 54113, 54396, 54458, 48106)) %>%
  summarise(count = n())

#print(noDL_count) #count is 9
```


## Traffic stops by result of stop {#traffic-result}

Across all three types of officer-initiated traffic stops (Equipment, Moving, Non-moving), a citation for infraction is the most common stop result. Equipment and non-moving traffic stops are more likely to result in only a warning verbal or written compared to moving traffic stops.

```{r}

# join to person-level traffic universe and analyze

df<-traffic%>%
  left_join(person_result)%>%
  group_by(traffic_violation_type)%>%
  mutate(total=n())%>%
  group_by(traffic_violation_type, stop_result_simple)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  select(traffic_violation_type, stop_result_simple, total, count,rate)%>%
  arrange(traffic_violation_type, -rate)%>%
  group_by(traffic_violation_type)%>%
   slice(1:3)

## ggplot-----------
  

ggplot(df, aes(x = stop_result_simple, y = rate))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(rate,1), "%")), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size = 3,
          color = "white")+ 
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 10))+
  labs(title = "Most Officer-Initiated Traffic Stops Result in a Citation", 
       subtitle = "Top three stop results for officer-initiated traffic stops by type",
       x = "", #labels to visual
       y = "") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
  facet_grid(. ~ traffic_violation_type)




```

### Traffic stops by result and perceived race

The graph below shows, across all traffic stop types (moving, equipment, non-moving), what percentage of stops resulted in a citation for infraction, in-field cite and release, or warning verbal or written across each perceived race group.

Note that the graphs filter out perceived racial groups where less than 10 people were stopped in traffic stops in 2022. 

Individuals Fresno PD perceived as Latinx and Black are stopped for traffic stops resulting only in a warning verbal or written at higher rates than other groups. 

```{r}

df<-traffic%>%
  left_join(race)%>%
  left_join(person_result)%>%
  group_by(nh_race)%>%
  mutate(total=n())%>%
  group_by(nh_race, stop_result_simple)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  ungroup()%>%
   mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'nh_sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))%>%
  select(Race, stop_result_simple, total, count,rate)%>%
  arrange(Race,  -rate)%>%
  filter(total>=10) %>%   
  filter(stop_result_simple=="in field cite and release"|
          stop_result_simple== "warning verbal or written"|
           stop_result_simple=="citation for infraction")

# graph


ggplot(df, aes(x = stop_result_simple, y = rate))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(rate,1), "%")), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size = 3,
          color = "white")+ 
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 10))+
  labs(title=str_wrap("People Perceived as SWANA/SA are Given Citations at Higher Rates than Other Groups", 80),
         subtitle = "Rate of traffic stops by top stop results and perceived race",
       x = "", #labels to visual
       y = "") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=0.5, size=7), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
  facet_grid(. ~ Race)


```

### Most common citations that resulted from traffic stop

Unsafe driving speed is the most common citation result from a traffic stop. Obstructed vehicle window and vehicle registration citations are the next most common citation results from a traffic stop. Diving deeper into the different types of citations given during traffic stops is important to understand whether or not traffic stops are being made for safety reasons.    

```{r}
# Total count/rate of each citation out of all traffic stops

# read in traffic citations table at person level
citation_result<-dbGetQuery(con, "SELECT * FROM rel_persons_citations")


# join to our traffic universe 

df<-traffic%>%
  left_join(person_result)%>%
  left_join(citation_result%>%
              mutate(person_number=as.character(person_number)))%>%
  filter(stop_result_simple=="citation for infraction" & 
           result_category == "Citation for infraction")%>%
  left_join(offense_codes)

# analyze

df<-df%>%
  select(offense_code,offense_statute,statute_literal_25,offense_type_of_charge)%>%
  mutate(total=n())%>%
  group_by(offense_type_of_charge,statute_literal_25)%>%
mutate(count=n(),
       rate=count/total*100)%>%
  slice(1)%>%
  arrange(-rate)%>%
  head(7)%>%
  select(-offense_code,-offense_statute)

#create and style flextable

names(df)<-tools::toTitleCase(gsub("_"," ",names(df))) # clean up column names for table

df<-df%>%
  rename("Statute"="Statute Literal 25",
         "Type of Charge"="Offense Type of Charge")

  flextable(df) %>%
colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Most Common Citations that Resulted From an Officer-Initiated Traffic Stop') %>%
  theme_vanilla() %>%
  width(j=3,2.5,unit="in")


```


### Traffic stops resulting in citations by race

Latinx people are least likely to be given a citation for speeding, but are more likely to be charged with driving without a license and window obstruction. People perceived as Black and Latinx by Fresno PD are stopped in traffic stops and given a citation for driving without a license at higher rates than all other groups. 

In general, people perceived as Black are disproportionately stopped in traffic stops and given a citation relative to how many Black people live in Fresno city. Out of all people stopped in traffic stops and given a citation, 11.1% were people Fresno PD perceived as Black, yet Black people make up 6.2% of Fresno city's total population. 

The graph below gives more detail into traffic citations given as a result of a traffic stop. It shows the top three traffic citation results for each perceived race. 

```{r}

## First analyze just traffic stops resulting in a citation by race to see generally which perceived race is receiving the most traffic citations

df<-traffic%>%
  left_join(person_result)%>%
   filter(stop_result_simple=="citation for infraction")%>%
  left_join(race)

# analyze

# race cut

df_nh<-df%>%
group_by(nh_race)%>%
summarise(count=n(),.groups='drop')%>%
mutate(rate=count/sum(count)*100)%>%
  arrange(nh_race, -rate)


```

```{r,  fig.width=9, fig.height=9}

df<-df%>%
   left_join(citation_result%>%
               filter(result_category=='Citation for infraction')%>%
   mutate(person_number=as.character(person_number)))%>%
   left_join(offense_codes, by=c("offense_code"="offense_code"))%>%
  group_by(nh_race)%>%
  mutate(total=n())%>%
  group_by(statute_literal_25, offense_default_type_of_charge, offense_type_of_charge,nh_race)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
   mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'nh_sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))%>%
  ungroup()%>%
  select(Race, statute_literal_25, total, count, rate)%>%
  group_by(Race)%>%
    arrange(Race, -count)%>%
   slice(1:3)%>%
  filter(total>=10) # filter for groups where at least 10 people were stopped in traffic


## ggplot-----------

df$statute_literal_25 = str_wrap(df$statute_literal_25, width = 10)
  

ggplot(df, aes(x = reorder_within(statute_literal_25, -rate, Race), y = rate))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(rate,1), "%")), #add percentage labels within the bars
          vjust=0, #center percentage within the bar
          size = 3.1,
          color = "black")+ 
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  labs(title=str_wrap("Stops of People Perceived as Latinx and Black More Likely to Result in Citation for Driving Without License",90),
       subtitle = str_wrap("Top three traffic citation results by perceived race",110), 
       x = "", #labels to visual
       y = "") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      # legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5, size=16),
      plot.subtitle = element_text(hjust=0.5, size=14))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=8), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        strip.placement = "outside",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
    facet_wrap(. ~ Race, ncol=2, scales = 'free_x') +
  scale_x_reordered()





```


### Traffic stops resulting in driving without license citation

```{r}

df<-traffic%>%
  left_join(person_result)%>%
  left_join(citation_result%>%
              mutate(person_number=as.character(person_number)))%>%
  filter(stop_result_simple=="citation for infraction" & 
           result_category == "Citation for infraction")%>%
  left_join(race)%>%
    left_join(offense_codes, by=c("offense_code"="offense_code"))%>%
  mutate(total=n())%>%
  filter(offense_statute=="12500(A)" |
          offense_statute=="12500(B)" |
           offense_statute=="12500(C)" |
           offense_statute=="12500(D)"|
           offense_statute=="12951(A)")%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  select(traffic_violation_type, statute_literal_25, total, count,rate)%>%
  arrange(-rate)


```

People Fresno PD perceive as Latinx and Black are stopped in traffic stops and given a citation for driving without a license at higher rates than other groups. Of the Latinx people officers stopped and cited, nearly 1 in 10 were given citations for driving without a license. 

```{r}

df<-traffic%>%
   left_join(person_result)%>%
  left_join(citation_result%>%
              mutate(person_number=as.character(person_number)))%>%
  filter(stop_result_simple=="citation for infraction" & 
           result_category == "Citation for infraction")%>%
  left_join(race)%>%
    left_join(offense_codes, by=c("offense_code"="offense_code"))%>%
  group_by(nh_race)%>%
  mutate(total=n())%>%
filter(offense_statute=="12500(A)" |
          offense_statute=="12500(B)" |
           offense_statute=="12500(C)" |
           offense_statute=="12500(D)"|
           offense_statute=="12951(A)")%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  select(nh_race, offense_statute, statute_literal_25, total, count,rate)%>%
  arrange(-rate)%>%
     mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'nh_sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))

# make table 

names(df)<-tools::toTitleCase(gsub("_"," ",names(df))) # clean up column names for table

df<-df%>%
  ungroup()%>%
  select(Race, "Total", "Count", "Rate")

  flextable(df) %>%
colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Traffic Stops Resulting in Driving without License Citation by Perceived Race') %>%
  theme_vanilla() %>%
  width(j=2,2,unit="in")

```


# Stop Results  {#results}

This section explores the results of stops, meaning what actions were taken against the person stopped and what happened during the stop, e.g., out of all officer-initiated stops, how many resulted in a citation. In some cases, we focus in on traffic stops.

## Officer-initiated stops by stop result

Nearly 80% of all officer-initiated stops result in a citation for infraction. About seven percent result in only a warning being given and less than one percent result in no action.

```{r}

df<-person%>%mutate(person_number=as.character(person_number))%>%
                      left_join(stops)%>%
  left_join(person_result)%>%
  filter(call_for_service==0) %>%
  group_by(stop_result_simple)%>%
summarise(count=n(),.groups='drop')%>%
mutate(rate=count/sum(count)*100)%>%
  arrange(-rate)

# format values in table

library(stringr)
df$stop_result_simple<-str_to_title(df$stop_result_simple, locale = "en")

# make table 

names(df)<-tools::toTitleCase(gsub("_"," ",names(df))) # clean up column names for table

  flextable(df) %>%
colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Officer-Initiated Stops by Stop Result') %>%
  theme_vanilla() %>%
  width(j=1, width=3, unit="in")

```


## Stops resulting in use of force {#useofforce}

Out of all people stopped during an officer-initiated stop, 99.7% of people stopped were indicated as having no instances of any use of force used towards them (5,046 total people) while 0.28% of people stopped were indicated in the data as having instances of use of force used against them (14 people). All officer-initiated incidents of use of force inflicted by Fresno PD in 2022 occurred during traffic stops. 

```{r}

# Create universe for use of force analysis: person and stop level data joined together and filtered for officer-initiated stops

uof<-person%>%
  mutate(person_number=as.character(person_number))%>%
  left_join(stops)%>%left_join(person_action%>%
  mutate(person_number=as.character(person_number)),
  by=c("stop_id","person_number"))%>%
    filter(call_for_service==0)

# Analysis

df<-uof%>%
  mutate(total=n())%>%
  group_by(use_of_force)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  select(use_of_force, count, rate)


```

```{r}

uof[,1:149] <- sapply(uof[,1:149],as.character) # convert all columns to varchar for joining

df0<-uof%>%
  filter(use_of_force==1)%>%
  left_join(person_reason, by =c("stop_id","person_number"))%>%
   left_join(offense_codes, by=c("rfs_traffic_violation_code.x"="offense_code"))%>%
  mutate(Total=n())%>%
  group_by(reason, statute_literal_25,offense_type_of_charge)%>%
  mutate(Count=n(),
         Rate=Count/Total*100)%>%
  slice(1)%>%
  select(use_of_force, reason, Total, Count, Rate)%>%
  arrange(-Count)%>%
  ungroup()%>%
  select(statute_literal_25, Count, Rate)%>%
  rename(
         "Statute"="statute_literal_25")

#create and style flextable

names(df)<-tools::toTitleCase(gsub("_"," ",names(df))) # clean up column names for table

# Create table so we can look at the traffic citation reasons for UoF

  flextable(df0) %>%
colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Use of Force by Stop Reason') %>%
  theme_vanilla() %>%
  width(j=2,2.5,unit="in")



```

Fresno PD disproportionately inflicted use of force towards people they perceived as Latinx men in 2022. Latinx people make up nearly 51% of the total population in Fresno City, but Latinx men alone made up nearly 50% of all use of force incidents. Additionally, 21.4% of use of force incidents were towards people perceived as Asian males despite Asian people only making up about 13% of Fresno's total population. 

```{r}

df_gender<-uof%>%
left_join(race)%>%
  filter(use_of_force==1)%>%
group_by(nh_race, g_full)%>%
summarise(count=n(),.groups='drop')%>%
mutate(rate=count/sum(count)*100)


# Format the gender table for visualizing 

df<-df_gender%>%
  mutate(g_full=ifelse(g_full %in% '1', 'Male',
                       ifelse(g_full %in% '2', 'Female',
                              g_full)))%>%
    mutate(nh_race=ifelse(nh_race %in% 'latinx', 'Latinx',
                       ifelse(nh_race %in% 'nh_asian', 'Asian',
                              ifelse(nh_race %in% 'nh_sswana', 'SWANA/SA',
                              "White"))))%>%
  rename("Perceived Gender"="g_full",
         "Perceived Race"="nh_race")%>%
  ungroup()%>%
  select(-3)%>%
  arrange("Perceived Race", -rate)

#create and style flextable

names(df)<-tools::toTitleCase(gsub("_"," ",names(df))) # clean up column names for table

  
flextable(df) %>%
colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Use of Force by Perceived Race and Gender') %>%
  theme_vanilla() %>%
   width(width = 1.5)
  


  


```


## Stops resulting in a field interview (FI) card {#ficard}

Two officer-initiated stops, with a total of four people stopped, resulted solely in a FI card being completed. All four FI cards were given to people during traffic stops. 

Every individual that Fresno PD stopped and completed FI cards for in 2022 was perceived by officers as Black or Latinx. Officers also perceived three of these individuals as male and one as female.

```{r, include=FALSE}

##Create df of all officer-initiated stops w/ stop result variables##
ois_result <- left_join(stops, person_result, by ="stop_id")%>%
  filter(call_for_service ==0) %>%
  select(stop_id, stop_result_simple, stop_result_list, everything())

##Create df to find count and rate of all stop results##
count_ois_result <- ois_result %>%
  group_by(stop_result_simple) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
    arrange(desc(Count)) %>%               # Change column names and value                                                 displays for more legible table
  rename('Recorded Stop Result' = stop_result_simple, 
         `# of Times Recorded` = Count, 
         `% of All Stop Results` = Percent) %>%
     mutate(`% of All Stop Results` = sprintf("%.2f%%", `% of All Stop Results`))

##Table to show result counts and rates of all OIS, with FI result highlighted##
flextable(count_ois_result) %>%
  set_caption('Results of Officer-Initiated Stops by Fresno PD (2022)') %>%
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header") %>%
   bold(i = 8, bold = TRUE, part = "body") %>%
  color(i = 8, color = "red", part = "body")


```

```{r, include=FALSE}

##Create df that includes only FI card results and merges in stop reason data##
fi_stop_reason <- left_join(ois_result, reason, by = "stop_id") %>%
  filter(
    stop_result_simple == "field interview card completed" |
    grepl("field interview", stop_result_list, ignore.case = TRUE)) %>%
  select(stop_id, stop_result_simple, stop_reason_simple, stop_result_list, everything())    #Only 4 stops where result was FI, reason for all was TV


```

```{r, include=FALSE}

##Merge age_race_gender with FI card df##
fi_stop_race_gender <- left_join(fi_stop_reason, age_race_gender_ois, by = "stop_id")   #Df shows 5 individuals who had FI cards filed,
              # 2 Black, 2 Latinx, 1 white.
              # 3 men, 2 women

```


## Stops resulting in referral to US Department of Homeland Security ICE {#ice}

Fresno PD reported that only one of their stops in 2022 resulted in a person being referred to the Department of Homeland Security/ICE. The one individual referred to ICE by Fresno PD in 2022 was stopped for a traffic violation. This one individual was perceived by officers as a Latinx male.

```{r, include=FALSE}

##count_ois_result shows us 0 under simple results, 
##query to see how many times it is listed under multiple results##
sum(grepl("homeland security", ois_result$stop_result_list, ignore.case = TRUE)) #only 1 total referral to ICE

```

```{r, include=FALSE}
##Create df for one ICE result and merge reason##
ice_reason <- left_join(ois_result, reason, by = "stop_id") %>%
  filter(grepl("homeland security", stop_result_list, ignore.case = TRUE)) %>%
  select(stop_id, stop_result_simple, stop_reason_simple, stop_result_list, everything())

```

```{r, include=FALSE}

##Merge in race and gender variables for one observation##
ice_race_gender <- left_join(ice_reason, age_race_gender_ois, by = "stop_id")

```


## Stops that resulted in a search that yielded no contraband {#contraband}

In 2022, Fresno PD searched 74 people in traffic stops. Of the 74 people Fresno PD searched in traffic stops, 41 people were perceived as Latinx and 12 people were perceived as Black.

```{r}

# PERSON LEVEL: analyze searches ONLY

df<-person_action%>%
  left_join(person_reason%>%
              mutate(person_number=as.numeric(person_number)))%>%
  left_join(stops)%>%
  filter(call_for_service==0)%>%
  filter(ads_search_person==1 | ads_search_property==1)%>%
  filter( reason == "Traffic violation")%>%
  left_join(race%>%mutate(person_number=as.numeric(person_number)))%>%
  mutate(total=n())%>%
  group_by(nh_race)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'aian' ~ 'AIAN',
    nh_race == 'nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'nh_sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))%>%
  ungroup()%>%
  select(Race, total, count,rate)


#create and style flextable
names(df)<-tools::toTitleCase(gsub("_"," ",names(df))) # clean up column names for table


  flextable(df) %>%
 colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Fresno PD Searches in Traffic Stops by Perceived Race') %>%
  theme_vanilla()%>%
       width(width = 1.1)

```

The table below shows the rate of searches that yield contraband during traffic stops within each perceived racial group (also known as hit rates). We can see across all perceived racial groups that only a small number of searches yield any contraband. 

```{r}

# analyze HIT RATES by race:  searches that yielded no contraband--------------------

df_hitrate<-person%>%
 left_join(person_action, by=c("stop_id", "person_number"))%>%
  left_join(person_reason%>%
              mutate(person_number=as.numeric(person_number)),
            by=c("stop_id", "person_number"))%>%
  left_join(stops)%>%
  filter(call_for_service==0)%>%
  filter(ads_search_person.x==1 | ads_search_property.x==1)%>%
  filter( reason == "Traffic violation")%>%
  left_join(race%>%mutate(person_number=as.numeric(person_number)))%>%
  group_by(nh_race)%>% # get total searches within each racial group
  mutate(total=n())%>%
  filter(ced_none_contraband==0)%>% # filter only where contraband was found
  mutate(count=n(),
         rate=count/total*100)%>% # get total searches where no contraband is found in each racial group
  slice(1)%>%
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'aian' ~ 'AIAN',
    nh_race == 'nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'nh_sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))%>%
  ungroup()%>%
  select(Race, total, count,rate)

  
  #create and style flextable
names(df_hitrate)<-tools::toTitleCase(gsub("_"," ",names(df_hitrate))) # clean up column names for table

  flextable(df_hitrate) %>%
 colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Fresno PD Searches During Traffic Stops That Yield Contraband by Perceived Race') %>%
  theme_vanilla()%>%
       width(width = 1.1)


```


# Time spent {#time}

The following analyzes the total and percent of time Fresno PD spent on certain stops to explore potential waste in public resources. We focus on officer-initiated stops. Overall, Fresno PD spent about 74.1% of their stop time on officer-initiated stops though stops for calls for service on average took longer (56 minutes on average per call for service stop compared to 9 minutes on average for officer-initiated).

## Time spent on stops by stop reason {#time-reason}

In 2022, Fresno PD spent nearly 98% of their stop time on stops originally made for traffic violations. While each of these stops took less time on average compared to other stop types, they made up the largest share of Fresno PD's time.

```{r}

# join data frames
time_reason_df<-stops%>%left_join(reason)

# get quick tallies of OIS vs. cfs
time_ois<-time_reason_df%>%group_by(call_for_service)%>%
  summarise(count_time=sum(stop_duration),
            avg_time=mean(stop_duration),
            median_time=median(stop_duration),
            .groups='drop')%>%
           mutate(percent_time=count_time/sum(count_time))

# time spent on stop reason for ois
time_reason_ois<-time_reason_df%>%filter(call_for_service==0)%>%
  group_by(stop_reason_simple)%>%
  summarise(total_time=sum(stop_duration),
            average_time=round(mean(stop_duration),1),
            median_time=median(stop_duration),
            .groups='drop')%>%
           mutate(percent_time=round(total_time/sum(total_time)*100,1))%>%
  arrange(desc(percent_time))%>%
  rename(stop_reason=stop_reason_simple)


#create and style flextable
names(time_reason_ois)<-tools::toTitleCase(gsub("_"," ",names(time_reason_ois))) # clean up column names for table

  flextable(time_reason_ois) %>%
# colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Time Spent in Minutes on Officer-initiated Stops by Stop Reason') %>%
  theme_vanilla()%>%
    width(j=1, width=2,unit="in")



```


## Time spent on traffic stops by stop result {#time-result}

The large majority of time spent on traffic stops is spent on stops only resulting in a citation for infraction. Nearly 73% of minutes Fresno PD spent on traffic stops were on stops resulting in a citation for infraction. On average, each of these stops only takes 8 minutes.


```{r}

# join data frames
time_result_df<-time_reason_df%>%left_join(results)

# time spent by result for ois and traffic
time_result_ois<-time_result_df%>%filter(call_for_service==0 & stop_reason_simple=='Traffic violation')%>%
  group_by(stop_result_simple)%>%
  summarise(total_time=sum(stop_duration),
            average_time=round(mean(stop_duration),1),
            median_time=median(stop_duration),
            .groups='drop')%>%
           mutate(percent_time=round(total_time/sum(total_time)*100,1))%>%
  arrange(desc(percent_time))%>%
  rename(stop_result=stop_result_simple)%>%
  mutate(stop_result=tools::toTitleCase(stop_result))

#create and style flextable
names(time_result_ois)<-tools::toTitleCase(gsub("_"," ",names(time_result_ois))) # clean up column names for table

  flextable(time_result_ois) %>%
# colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Time Spent in Minutes on Traffic Stops by Stop Result') %>%
  theme_vanilla()%>%   
    width(j=1, width=2,unit="in")



```


## Time spent on traffic stops by race {#time-race}

On average, Fresno PD spent slightly longer on traffic stops of individuals perceived as Black and Latinx (about 1 minute longer looking at the median time or quartile 3 time). Quartile 1 represents the 25th percentile of stop duration, meaning that 25% stops in that racial group took less than that specified time. Quartile 3 represents the 75th percentile of stop duration, meaning that 75% stops in that racial group took less than that specified time.

Stops of individuals perceived as White in Fresno only took 1 in 4 minutes of Fresno PD's stop time on traffic violations.

```{r}

# join data frames
time_race_df<-time_result_df%>%left_join(race)

# time spent by race for traffic
time_race_traffic<-time_race_df%>%filter(call_for_service==0 & stop_reason_simple=='Traffic violation')%>%
  group_by(nh_race)%>%
  summarise(total_time=sum(stop_duration),
            average_time=round(mean(stop_duration),1),
            median_time=median(stop_duration),
            count=n(),
            quartile_1_time=quantile(stop_duration,probs=c(.25)),
           quartile_3_time=quantile(stop_duration,probs=c(.75)),
            .groups='drop')%>%
           mutate(percent_time=round(total_time/sum(total_time)*100,1))%>%
  arrange(desc(percent_time))

# clean up 
time_race_traffic_df<-time_race_traffic%>%
 mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'aian' ~ 'AIAN',
    nh_race == 'nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'nh_sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))%>%
  filter(count>5)%>%
  select(-count,-nh_race)%>%
  select(Race,total_time,percent_time,everything())
    
#create and style flextable
names(time_race_traffic_df)<-tools::toTitleCase(gsub("_"," ",names(time_race_traffic_df))) # clean up column names for table

  flextable(time_race_traffic_df) %>%
# colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Time Spent in Minutes on Traffic Stops by Race') %>%
  theme_vanilla() 
    # width(width=2,unit="in")



```