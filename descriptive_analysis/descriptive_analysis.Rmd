---
title: "Fresno RIPA Data Project"
subtitle: "Descriptive Analysis"
author: "Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    toc: yes
    toc_depth: 2
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)


#### Load libraries ####
library(usethis)
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
library(flextable)
library(htmlwidgets)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(scales)
library(dplyr)
library(ggplot2)

#add function that better fits the tables to the page    
FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

#### Add database connection ####

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("eci_fresno_ripa")

#### Read in tables you need from postgres ####

# You can use the RDA Data Dictionary to look up column meta data for any of these tables. The dictionary is structured the same as pgadmin: https://www.healthycity.org/rda-dev/pgdatadictionary/ 

stops<-dbGetQuery(con, "SELECT * FROM rel_stops")
results<-dbGetQuery(con, "SELECT * FROM rel_stops_result")
person<-dbGetQuery(con, "SELECT * FROM rel_persons")
person_reason<-dbGetQuery(con, "SELECT * FROM rel_persons_reason")
age<-dbGetQuery(con, "SELECT * FROM rel_age")
race<-dbGetQuery(con, "SELECT * FROM rel_races_recode") ##Updated code. table name on postgres is rel_races_recode





```

Before engaging in a detailed analysis of Fresno PD patrol activity as outlined in the research plan, we created this descriptive analysis to explore overall trends in the Fresno RIPA data. This helps us determine if our expected findings are likely to show up in the data and allows us to identify any trends we did not expect. We include basis tallies on each of the following:

# Stops overview 

## Number and Rate of Officer-Initiated Stops vs. Calls for Service

In 2022, there were 5,317 police stops made by Fresno PD. Of those stops, __5028 were officer-initiated stops__ and __289 were calls for service.__

In 2022, __94.6%___ of Fresno Police Department stops were officer initiated stops while __only 5.4%__ of stops were calls for service.

```{r}
# Use the 'rel_stops' table to calculate the rate and count of officer initiated stops &  calls for service. 

###CALCULATE TOTAL OFFICER INITIATED STOPS##
count_ois <- stops %>%  
  filter(call_for_service == 0) %>% #filters for Officer-Initiated Stops
    select(stop_id) %>% 
       mutate('Total Officer Initiated Stops' = n()) %>%  
         slice(1) %>% 
           select(-stop_id) 

###CALCULATE CALLS FOR SERVICE TOTAL###
count_cfs <- stops %>%
  filter(call_for_service == 1) %>% 
    select(stop_id) %>% 
      mutate('Total Calls for Service' =n()) %>% 
       slice(1) %>% 
           select(-stop_id) 


### CALCULATE THE RATE OF OFFICER INITIATED STOPS AND CALLS FOR SERVICE###

rate_ois <- stops %>%
  group_by(Stop_Type = call_for_service == 0) %>%
    summarise (percent = 100 * n()/ nrow(stops)) %>%
      mutate(percent =round(percent, digits =1),
        Stop_Type = ifelse(Stop_Type, "Officer Initiated Stop", "Calls for Service")) %>%
  rename('Type' = 'Stop_Type')




###BAR CHART to VISUALIZE RATE OF CALLS FOR SERVICE VS OFFICER INITIATED STOP###

rate_ois <- data.frame( #create df to create a visual later
  Type = c("Officer-Initiated Stop", "Calls for Service"),
  percent = c(94.6, 5.4))

ggplot(rate_ois, aes(x = Type, y = percent, fill = Type))+
  geom_bar(stat = "identity") + #to create barplot
  geom_text(aes(label = paste0(round(percent,1), "%")), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size = 3,
          color = "white")+ 
  labs(title = "Rate of Stop Types (%)", #labels to visual
       x = "Type of Stop",
       y = "Percentage (%)") +
  scale_fill_manual(values = c("Officer-Initiated Stop"="#362178",
      "Calls for Service" = "#362178" ))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5))+ 
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())


```


## Total number of people stopped 

In 2022, Fresno PD stopped a total of __5,060 people__ through Officer-Initiated Stops.
```{r}

# Use the 'rel_persons' AND 'rel_stops' table to calculate total number of people stopped for officer-initiated stops

tot_ois <- left_join(stops, person, by ="stop_id")%>%
  select(call_for_service)%>%
  filter(call_for_service ==0)%>%  
    summarise(count=n())%>%
     ungroup()%>%
       mutate(total=sum(count))%>%
        rename("Total Number of People Stopped for Officer-Initiated Stops" = count)



```

# Demographics 

## Race

Officer-initiated stops by perceived race of persons stopped

```{r}

# Calculate the count and rate of officer-initiated stops by perceived race of person stopped. Use the 'rel_races_recode' table & 'rel_stops'

##CALCULATES COUNT AND RATE FOR OIS BY RACE##
race_ois<- left_join(stops, race, by ="stop_id")%>% #joining tables 
  filter(call_for_service ==0)%>% #filtering for OIS
  select(nh_race)%>% # Selecting race column and adding finding the count for each
  mutate(Total=n())%>%
  group_by(nh_race)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% # finding rate and rounding to tenths place
  slice(1)%>%
  rename('Race' ='nh_race')%>%
  arrange(-Percent)

##VISUALIZATION FOR RATE OF OIS BY RACE ##

ggplot(race_ois, aes(x = reorder(Race, -Percent), y = Percent, fill = Race))+
  geom_bar(stat = "identity") + #to create barplot
  geom_text(aes(label = paste0(Percent, "%")), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size =3,
          color = "white")+ 
  labs(title = "Officer-Initiated Stops by Race",
       x = "Race",
       y = "Percentage (%)") +
  scale_fill_manual(values = c("#362178", "#362178", "#362178", "#362178", "#362178", "#362178", "#362178"))+
  theme_bw()+
  theme(plot.title = element_text(hjust =0.5),
 #sets y-axis labels to be horizontal
      legend.position ="none", #removes legend
      axis.text.y = element_text(angle =0, hjust=1), #Makes y-axis text readable
      axis.text.x = element_text(angle =0, hjust=0.5)) +
  theme(axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())
#Makes x-axis text readable

```


## Age 

Officer-initiated stops by perceived age of persons stopped

```{r}

# Calculate the count and rate of officer-initiated stops by age-brackets of person stopped. Use the 'rel_age' table & 'rel_stops'

age_ois<- left_join(age, stops, by ="stop_id")%>% #Joined tables
  filter(call_for_service ==0)%>% #Filtered for OIS
  select(age_group_re)%>% # Selected table of interest
  mutate(Total=n())%>% #To find total number for OIS 
  group_by(age_group_re)%>% # Grouping by recoded age brackets
  mutate(Count=n(), 
         Percent = round(Count/Total*100, 1))%>% #Create percentages and rounding them to tenths place
  slice(1)%>%
  rename('Age' ='age_group_re')%>%
  arrange(-Percent)

#########VISUALIZATION FOR RATE OF OIS BY AGE GROUP########

ggplot(age_ois, aes(x = Age, y=Percent))+
      geom_bar( stat = "identity", fill="#362178") + #create barchart 
  geom_text(aes( label = paste0(round(Percent, digits=1),"%" ), #round to tenths place within barchart label
                 y= Percent),
            vjust = 1.4, 
            size =3,
            color = "white",
             fontface = "bold")+
    labs(title = "Officer-Initiated Stops by Age Group",
      x = "Age Group", #labels
  y = "Percentage (%)")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
    theme(plot.title = element_text(hjust =0.5),
  axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=10), #for label and axis settings
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())


```


## Gender 

Officer-initiated stops by perceived gender of persons stopped

```{r}

# Calculate people stopped for officer-initiated stop by perceived gender. Use the table 'rel_persons' & 'rel_stops'

  gender_ois<- left_join(person, stops, by ="stop_id")%>% 
  filter(call_for_service ==0)%>%
  select(g_full)%>% 
  mutate(Total=n())%>%
  group_by(g_full)%>%
  mutate(Count=n(), 
         Percent = round(Count/Total*100, 1))%>%
  slice(1)%>%
  rename('Gender' ='g_full')%>%
  arrange(-Percent)

##RECODING FOR GENDER SO THAT X-AXIS DISPLAYS GENDERS INSTEAD OF 1:5##

gender_recode <- data.frame(
  value = c("Male", "Female", "Transgender Man/Boy", "Transgender Woman/Girl", "Nonconforming"))

gender_df <-cbind(gender_ois, gender = gender_recode)##COMBINE GENDER_OIS WITH GENDER                                                             RECODE TO MAKE ONE DATAFRAME##


#########VISUALIZATION FOR OIS BY PERCEIVED GENDER########

ggplot(gender_df, aes(x= reorder(value, -Percent), y= Percent, fill = value))+ #'value' comes from adding name of perceived gender and combining it with gender_ois table

      geom_bar( stat = "identity", fill="#362178") + #create barchart 
  geom_text(aes(label = paste0(round(Percent, digits=1),"%"), #round to tenths place within barchart label
                 y= Percent),
            vjust = 1.4, 
            size =3,
            color = "white",
             fontface = "bold")+
    labs(title = "Officer-Initiated Stops by Perceived Gender",
      x = "Perceived Gender", #labels
  y = "Percent (%)")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
  theme(plot.title = element_text(hjust =0.5),
  axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=7), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())

```

## Race by age and gender

Rate and count of perceived gender and age of people stopped within each perceived racial group


```{r}

# Calculate the distribution of perceived gender/age of people stopped within each perceived racial group. 

  age_race_gender_ois<- left_join(age, stops, by ="stop_id")%>% 
  left_join(race, by =c("stop_id","person_number"))%>%
  left_join(person%>%mutate(person_number=as.character(person_number)),by =c("stop_id","person_number"))

age_race_gender_ois_table<-age_race_gender_ois%>%
  filter(call_for_service ==0)%>% #Filtered for OIS
  group_by(age_group_re)%>%
  mutate(total_age=n())%>% #To find total number for each age group
  group_by(age_group_re,nh_race,g_full,total_age)%>% # Grouping by all 3 variables and keeping the total per age group recoded
  summarise(Count=n(), # count for the age/race/gender combo
         Percent = round(Count/total_age*100, 1))%>% # percentage for the race/gender combo out of the age category
  slice(1)

##Visualization for distribution##

gender_legend_re <- c("1" = "Male", "2" = "Female", "3" = "Transgender Man", "4"="Transgender Woman", "5"= "Gender Nonconforming")

ggplot(age_race_gender_ois_table, aes(x =nh_race, y = Percent, fill = g_full))+ ##Problem with Graph - clusters the races
  geom_bar(stat = "identity", position="stack") +
  facet_wrap(~age_group_re)+
 labs(x= "Race", y = "Percentage (%)", fill="Gender", title ="Distribution of OIS by Race, Gender, and Age")+
  scale_fill_manual(values = c("#003f5c", "#05518f", "#565cbb", "#00a2a5", "#00d38c"), labels= gender_legend_re)+
  theme_minimal()+
  theme(
    plot.title= element_text(hjust=0.5),
    axis.text.x = element_text(angle=90, hjust=0, size=7),
        strip.text.x = element_text(size=8),
        strip.text.y = element_text(size=8),
        panel.spacing = unit(0.5, "lines"))


 
```


# Stop Reasons

## Total counts and rates

```{r}

# Total count and rates of officer-initiated stops by stop reason. Officer-initiated stops is the denominator. 



```


## Traffic stops by type

```{r}

# Total count and rates of traffic stops by each traffic stop type: 1 Moving; 2 Equipment; 3 Nonmoving; Blank. 

#Denominator is out of all officer-initiated traffic stops. 



```


## Citations within equipment/non-moving traffic stops

```{r}

# This can be a table looking at the top 50 citations within non-moving/equipment traffic stop types. Denominator is non-moving/equipment traffic stops

# Use table 'rel_persons_reason' and the column 'rfs_traffic_violation_code.' You can look up the citation codes here: "W:\Project\ECI\Fresno RIPA\Data\sdcs-look-up-table-2023.v2.xlsx"  



```

## Traffic stops that result in a citation for driving without a license

```{r}

# Calculate count of traffic stops that result with a citation for driving without a license. You can look up the citation codes here: "W:\Project\ECI\Fresno RIPA\Data\sdcs-look-up-table-2023.v2.xlsx"


```

# Stop Results

## Over-all stops by stop result out of all officer-initiated stops

## Traffic Citations as Stop Result

### Total count/rate of each citation out of all officer-initiated stops


## Use of Force

### Total count/rate out of all officer-initiated stops

### Total count/rate by stop reason

### By race

## Field Interview (FI) Card

### Total count/rate out of all officer-initiated stops

### Total count/rate by stop reason 

### By race


## Referral to US Department of Homeland Security ICE

### Total count/rate out of all officer-initiated stops

### Total count/rate by stop reason

### By race

## Stops with a search that resulted in no contraband [RDA: lower prioritiy]

### Total count/rate out of all officer-initiated stops

# Time spent

## Time spent by stop reason

## Time spent by stop result





