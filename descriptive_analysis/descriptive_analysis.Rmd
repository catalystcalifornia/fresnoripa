---
title: "Fresno RIPA Data Project"
subtitle: "Descriptive Analysis"
author: "Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    toc: yes
    toc_depth: 2
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)


#### Load libraries ####
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
library(flextable)
library(htmlwidgets)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(scales)
library(dplyr)
library(ggplot2)

#add function that better fits the tables to the page    
FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

#### Add database connection ####

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("eci_fresno_ripa")

#### Read in tables you need from postgres ####

# You can use the RDA Data Dictionary to look up column meta data for any of these tables. The dictionary is structured the same as pgadmin: https://www.healthycity.org/rda-dev/pgdatadictionary/ 

stops<-dbGetQuery(con, "SELECT * FROM rel_stops")
results<-dbGetQuery(con, "SELECT * FROM rel_stops_result")
person<-dbGetQuery(con, "SELECT * FROM rel_persons")
person_reason<-dbGetQuery(con, "SELECT * FROM rel_persons_reason")
age<-dbGetQuery(con, "SELECT * FROM rel_age")
race<-dbGetQuery(con, "SELECT * FROM rel_races_recode") 
person_result<-dbGetQuery(con, "SELECT * FROM rel_persons_result")
actions<-dbGetQuery(con, "SELECT * FROM rel_stops_actions")
reason<-dbGetQuery(con, "SELECT * FROM rel_stops_reason")


```

Before engaging in a detailed analysis of Fresno PD patrol activity as outlined in the research plan, we created this descriptive analysis to explore overall trends in the Fresno RIPA data. This helps us determine if our expected findings are likely to show up in the data and allows us to identify any trends we did not expect. We include basis tallies on each of the following:

# Stops overview 

## Total number and rate of officer-initiated stops

In 2022, there were a __total of 5,317 police stops__ made by Fresno PD. Of those stops, __5,028 were officer-initiated stops__ and __289 were calls for service.__

In 2022, __94.6%__ of Fresno Police Department stops were officer initiated stops while __only 5.4%__ of stops were calls for service.

```{r}
# Use the 'rel_stops' table to calculate the rate and count of officer initiated stops &  calls for service. 

###CALCULATE TOTAL OFFICER INITIATED STOPS##

count_ois <- stops %>%  
  filter(call_for_service == 0) %>% #filters for Officer-Initiated Stops
    select(stop_id) %>% 
       mutate('Total Officer Initiated Stops' = n()) %>%  
         slice(1) %>% 
           select(-stop_id) 

###CALCULATE CALLS FOR SERVICE TOTAL###

count_cfs <- stops %>%
  filter(call_for_service == 1) %>% 
    select(stop_id) %>% 
      mutate('Total Calls for Service' =n()) %>% 
       slice(1) %>% 
           select(-stop_id) 


### CALCULATE THE RATE OF OFFICER INITIATED STOPS AND CALLS FOR SERVICE###

rate_ois <- stops %>%
  group_by(Stop_Type = call_for_service == 0) %>%
    summarise (percent = 100 * n()/ nrow(stops)) %>%
      mutate(percent =round(percent, digits =1),
        Stop_Type = ifelse(Stop_Type, "Officer Initiated Stop", "Calls for Service")) %>%
  rename('Type' = 'Stop_Type')




###BAR CHART to VISUALIZE RATE OF CALLS FOR SERVICE VS OFFICER INITIATED STOP###

rate_ois <- data.frame( #create df to create a visual later
  Type = c("Officer-Initiated Stop", "Calls for Service"),
  percent = c(94.6, 5.4))

ggplot(rate_ois, aes(x = Type, y = percent, fill = Type))+
  geom_bar(stat = "identity") + #to create barplot
  geom_text(aes(label = paste0(round(percent,1), "%")), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size = 3,
          color = "white")+ 
  labs(title = "Nearly 95% of All Stops Fresno PD Makes Are Not Responding to Community Calls", 
       subtitle = "Percentage of Police Stops by Stop-Type Made by Fresno PD in 2022",
       x = "", #labels to visual
       y = "") +
  scale_fill_manual(values = c("Officer-Initiated Stop"="#362178",
      "Calls for Service" = "#362178" ))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())


```


## Total number of people stopped for officer-initiated stops

In 2022, Fresno PD stopped a total of __5,060 people__ through officer-initiated stops.

```{r}

# Use the 'rel_persons' AND 'rel_stops' table to calculate total number of people stopped for officer-initiated stops

tot_ois <- left_join(stops, person, by ="stop_id")%>%
  select(call_for_service)%>%
  filter(call_for_service ==0)%>%  
    summarise(count=n())%>%
     ungroup()%>%
       mutate(Total=sum(count))%>%
        rename("Total Number of People Stopped for Officer-Initiated Stops" = count)


```

# Demographics 

## Perceived race of people stopped

Fresno PD __mostly stops people they perceive Latinx__ during officer-initiated stops. Over half of people stopped during these encounters are Latinx. For reference, about 50.5% of Fresno City's population is Latinx. As a comparison, __11.3%__ of people they stopped Fresno PD __perceived as Black__ while the __Fresno City's population only comprises of 6.2% Black people__.

```{r}

# Calculate the count and rate of officer-initiated stops by perceived race of person stopped. Use the 'rel_races_recode' table & 'rel_stops'

##CALCULATES COUNT AND RATE FOR OIS BY RACE##

df_race <-  left_join(stops, race, by ="stop_id")%>% #joining tables 
  filter(call_for_service ==0)


df_nh <- df_race %>% ##creates df for nh_race
  select(nh_race)%>% 
  mutate(Total=n())%>%
  group_by(nh_race)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)

df_sswana <- df_race %>% #creates df for sswana
  mutate(Total=n())%>%
  group_by(sswana_flag)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)%>%
  ungroup()%>%
  select(sswana_label, Total, Count, Percent)%>%
    rename(nh_race=sswana_label)

df_nhpi <- df_race %>% #creates df for nhpi
  mutate(Total=n())%>%
  group_by(nhpi_flag)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)%>%
  ungroup()%>%
  select(nhpi_label, Total, Count, Percent)%>%
    rename(nh_race=nhpi_label)

df_aian <- df_race %>% #creates df for aian
  mutate(Total=n())%>%
  group_by(aian_flag)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)%>%
  ungroup()%>%
  select(aian_label, Total, Count, Percent)%>%
  rename(nh_race=aian_label)
  
final_race <- rbind(df_nh%>%filter(!nh_race %in% c("nh_aian","nh_sswana","nh_nhpi")), 
                    df_sswana%>%filter(nh_race=='sswana'),
                    df_aian%>%filter(nh_race=='aian'),
                    df_nhpi%>%filter(nh_race=='nhpi')) ##combines nh_race and sswana, nhpi, aian

qa<-df_race%>%group_by(nh_race,sswana_flag, aian_flag,nhpi_flag)%>%summarise(count=n())

## Recode for nh_race for visual labels

final_race <- final_race %>%
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'aian' ~ 'AIAN',
    nh_race == 'nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
     nh_race == 'sswana' ~ 'SWANA/SA', 
    TRUE ~ as.character(nh_race)))
    
                      

##ADDING TOTAL NUMBER TO LABEL##

final_race <- final_race%>%
  mutate(label = paste0("Total: ", Count, "\n", round(Percent, 1),"%"))

##VISUALIZATION FOR RATE OF OIS BY RACE ##

ggplot(final_race, aes(x = reorder(Race, -Percent), y = Percent, fill = Race))+
  geom_bar(stat = "identity") + #to create barplot
  geom_text(aes(label = label), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size =3,
          color = "white")+ 
  labs(title = "Latinx Individuals Make Up Half of Officer-Initiated Stops by Fresno PD",
       subtitle = "Percentage of People Stopped During Officer-Initiated Stops by Perceived Race",
       x = "",
       y = "") +
  scale_fill_manual(values = c("#362178", "#362178", "#362178", "#362178", "#362178", "#362178", "#362178","#362178"))+
  theme_bw()+
  theme(plot.title = element_text(hjust =0.5),
        plot.subtitle = element_text(hjust =0.5),
 #sets y-axis labels to be horizontal
      legend.position ="none", #removes legend
      axis.text.y = element_text(angle =0, hjust=1), #Makes y-axis text readable
      axis.text.x = element_text(angle =0, hjust=0.5)) +
  theme(axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())
#Makes x-axis text readable

```


## Perceived age of people stopped 

Individuals __aged 25-34__ experienced the highest numbers of officer-initiated stops by Fresno PD in the year 2022.

```{r}

# Calculate the count and rate of officer-initiated stops by age-brackets of person stopped. Use the 'rel_age' table & 'rel_stops'

age_ois<- left_join(age, stops, by ="stop_id")%>% #Joined tables
  filter(call_for_service ==0)%>% #Filtered for OIS
  select(age_group_re)%>% # Selected table of interest
  mutate(Total=n())%>% #To find total number for OIS 
  group_by(age_group_re)%>% # Grouping by recoded age brackets
  mutate(Count=n(), 
         Percent = round(Count/Total*100, 1))%>% #Create percentages and rounding them to tenths place
  slice(1)%>%
  rename('Age' ='age_group_re')%>%
  arrange(-Percent)

#########VISUALIZATION FOR RATE OF OIS BY AGE GROUP########

ggplot(age_ois, aes(x = Age, y=Percent))+
      geom_bar( stat = "identity", fill="#362178") + #create barchart 
  geom_text(aes( label = paste0(round(Percent, digits=1),"%" ), #round to tenths place within barchart label
                 y= Percent),
            vjust = 1.4, 
            size =3,
            color = "white",
             fontface = "bold")+
    labs(title = "People Ages 25-34 Account for Nearly 35% of Officer-Initiated Stops by Fresno PD",
         subtitle= "Percentage of People Stopped During Officer-Initiated Stops by Perceived Age",
      x = "", #labels
  y = "")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
    theme(plot.title = element_text(hjust =0.5, size = 11.5, face="bold"),
          plot.subtitle = element_text(hjust=0.5),
  axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=10), #for label and axis settings
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())


```


## Perceived gender of people stopped 


In 2022, people identified as men (males) accounted for __nearly 57%__ of officer-initiated stops by Fresno PD.

```{r}

# Calculate people stopped for officer-initiated stop by perceived gender. Use the table 'rel_persons' & 'rel_stops'

  gender_ois<- left_join(person, stops, by ="stop_id")%>% 
  filter(call_for_service ==0)%>%
  select(g_full)%>% 
  mutate(Total=n())%>%
  group_by(g_full)%>%
  mutate(Count=n(), 
         Percent = round(Count/Total*100, 1))%>%
  slice(1)%>%
  arrange(-Percent)

##RECODING FOR GENDER SO THAT X-AXIS DISPLAYS GENDERS INSTEAD OF 1:5##

gender_ois <- gender_ois %>%
  mutate(Gender = recode(g_full,
                         '1'= 'Male',
                         '2' = 'Female',
                         '3' = "Transgender Man/Boy",
                         '4' = 'Transgender Woman/Girl',
                         '5' = 'Gender Nonconforming'))


#########VISUALIZATION FOR OIS BY PERCEIVED GENDER########

ggplot(gender_ois, aes(x= reorder(Gender, -Percent), y= Percent, fill = Gender))+
      geom_bar( stat = "identity", fill="#362178") + #create barchart 
  geom_text(aes(label = paste0(round(Percent, digits=1),"%"), #round to tenths place within barchart label
                 y= Percent),
            vjust = 1.4, 
            size =3,
            color = "white",
             fontface = "bold")+
    labs(title = "Males Account for Nearly 57% of Officer-Initiated Stops",
         subtitle = "Officer-Initiated Stops by Perceived Gender in 2022",
      x = "", #labels
  y = "")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
  theme(plot.title = element_text(hjust =0.5),
         plot.subtitle = element_text(hjust=0.5),
  axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=8), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())

```


## Perceived race and age group

In all age groups except for 55-64 and 65 and older, Latinx individuals make up nearly 50% or more of the officer-initiated stops by Fresno PD. For reference, generally Latinx individuals make up 50.5% of the Fresno population. By comparison, Black individuals make up 6.2% of the Fresno population and SWANA/SA individuals 6.1%. __In most age groups, Black individuals make up a higher percent of Fresno PD's officer-initiated stops, beyond their general share of the Fresno population.__


In 2022, White individuals within the age groups of 55-64 and 65 and older were the most frequently stopped during officer-initiated stops by Fresno PD. White individuals may make up a higher share of the population in these age groups in Fresno. Generally, White individuals make up 25.4% of the Fresno population.

```{r}

race_age_ois <- left_join(age, stops, by ="stop_id")%>% 
  left_join(race, by =c("stop_id","person_number"))%>%
  left_join(person%>%mutate(person_number=as.character(person_number)),by =c("stop_id","person_number"))

race_age_ois<-race_age_ois%>%
  filter(call_for_service ==0)%>% #Filtered for OIS
  group_by(age_group_re)%>%
  mutate(total_age=n())%>% #To find total number for each age group
  group_by(age_group_re,nh_race,total_age)%>% # Grouping by all 3 variables and keeping the total per age group recoded
  summarise(Count=n(), # count for the age/race combo
         Percent = round(Count/total_age*100, 1))%>% # percentage for the race combo out of the age category
  slice(1)

##Clean to make Flextable##


race_age_ois <- race_age_ois%>% #Rename column
  rename('Age Group' = age_group_re, 'Total' = total_age)



race_age_ois <- race_age_ois %>% #Recode for race
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
      nh_race == 'nh_sswana' ~ 'SSWANA'))

####Deleting nh_race columns to make a cleaner flextable####
race_age_ois <- race_age_ois[, !names(race_age_ois) %in% c("nh_race")]

#####Reordering columns#####
race_age_ois <- race_age_ois %>% 
  select(`Age Group`, Race, everything())

# ##Flextable for Age Group, Race##
#   flextable(race_age_ois) %>% 
#   set_caption('Officer-Initiated Stops in 2022 by Race and Age') %>% 
#   theme_vanilla() %>%
#   width(width=2,unit="in")
  
  ##Visualization for distribution##
ggplot(race_age_ois, aes(x = Race, y = Percent))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(Percent,1), "%"),y=Percent+5), #add percentage labels within the bars
          position = position_dodge(2), #center percentage within the bar
          # vjust = "outward",
          size = 3)+
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 10))+
  labs(title = "Latinx People Make Up Most Stops by Age, but Black People Are Overrepresented", 
       subtitle = "Officer-Initiated Stops in 2022 by Race and Age",
       x = "", #labels to visual
       y = "Percent of Age Group") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=8), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
     facet_wrap(. ~ `Age Group`,nrow=4,scales='free_x')

```

## Perceived age by race and gender

In 2022, __people perceived as men (males) were the most frequently stopped group across most age and race combinations__. Latinx men ages 18-34, followed by Latinx women ages 25-34, had the highest number of stops by Fresno PD during officer-initiated stops.

In 2022, __Latinx men ages 17 and under comprised more than 40% of people stopped under the age of 17__. Similarly, Latinx men ages 18-24 made up about 37% of people stopped between the ages of 18-24.

```{r}

# Calculate the distribution of perceived gender/age of people stopped within each perceived racial group. 

age_race_gender_ois<- left_join(age, stops, by ="stop_id")%>% 
  left_join(race, by =c("stop_id","person_number"))%>%
  left_join(person%>%mutate(person_number=as.character(person_number)),by =c("stop_id","person_number"))

age_race_gender_ois_table<-age_race_gender_ois%>%
  filter(call_for_service ==0)%>% #Filtered for OIS
  group_by(age_group_re)%>%
  mutate(total_age=n())%>% #To find total number for each age group
  group_by(age_group_re,nh_race,g_full,total_age)%>% # Grouping by all 3 variables and keeping the total per age group recoded
  summarise(Count=n(), # count for the age/race/gender combo
         Percent = round(Count/total_age*100, 1))%>% # percentage for the race/gender combo out of the age category
  slice(1)

 ##Clean to make Flextable##

age_race_gender_ois_table <- age_race_gender_ois_table %>% #Recode for Race#
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
      nh_race == 'nh_sswana' ~ 'SSWANA'))


age_race_gender_ois_table <- age_race_gender_ois_table %>% ##Recode for Gender##
  mutate(Gender = recode(g_full,
                         '1'= 'Male',
                         '2' = 'Female',
                         '3' = "Transgender Man/Boy",
                         '4' = 'Transgender Woman/Girl',
                         '5' = 'Gender Nonconforming'))


age_race_gender_ois_table <- age_race_gender_ois_table%>% ###Renaming columns### 
  rename('Age Group' = age_group_re, 'Total' = total_age )


####Deleting nh_race and  g_full columns to make a cleaner flextable####
age_race_gender_ois_table <- age_race_gender_ois_table[, !names(age_race_gender_ois_table) %in% c("nh_race", "g_full")]

# add percent out of race and age
age_race_gender_ois_table<-age_race_gender_ois_table%>%
  group_by(`Age Group`,Race)%>%
  mutate(total_race=sum(Count))%>%
  ungroup%>%
  mutate(percent_race=Count/total_race*100)

#####Reordering columns#####
age_race_gender_ois_table <- age_race_gender_ois_table%>% 
  select(`Age Group`, Race, Gender, everything())%>%
  filter(Gender=='Male' | Gender=='Female')

# ##Flextable for Age Group, Race, and Gender##
#   flextable(age_race_gender_ois_table) %>% 
#   set_caption('Officer-Initiated Stops Over Time by Age Group, Race, and Gender') %>% 
#   theme_vanilla() %>%
#   width(width=2,unit="in")

ggplot(age_race_gender_ois_table, aes(x = Race, y = Percent,fill=Gender))+
  geom_bar(stat = "identity"
           ) + 
   scale_fill_manual(values = c("#CEC4E2","#362178"))+#to create barplot
  # geom_text(aes(label = paste0(round(Percent,1), "%"),y=Percent+5), #add percentage labels within the bars
  #         # position = position_dodge(2), #center percentage within the bar
  #         # vjust = "outward",
  #         size = 3)+
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 10))+
  labs(title = "Men Account for Most Stops Across Age and Race Groups", 
       subtitle = "Officer-Initiated Stops in 2022 by Age, Race, and Gender",
       x = "", #labels to visual
       y = "Percent of Age Group") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=8), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
     facet_wrap(. ~ `Age Group`,nrow=4,scales='free_x')    

```


# Stop Reasons

The following explores the most common reasons for officer-initiated stops in 2022. __Traffic violations__ are the overwhelming majority of officer-initiated stops that Fresno PD made in 2022, exceeding more than what is seen in other police jurisdictions in California. For this reason, we explore [traffic stops](#traffic) more in depth as its own section. 


## Officer-initiated stops by stop reason

The Fresno Police Department makes an overwhelming majority of their officer-initiated stops for traffic violations. In 2022, __Over 99%__ of people stopped by Fresno PD officers were stopped due to a perceived traffic violation.

```{r}

# Total count and rates of officer-initiated stops by stop reason. Use officer-initiated stops is the denominator. For this use tables: rel_stops & rel_stops_reason 

# Feel free to visualize as a bar graph, table, or whatever you think works best!

##Create df of all officer-initiated stops w/ stop reason variables##
ois_reason <- left_join(stops, person_reason, by ="stop_id")%>%
  filter(call_for_service ==0) %>%
  select(stop_id, reason, everything())

##Create df with rates and counts by stop reason##
count_ois_reason <- ois_reason %>%
  group_by(reason) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
    arrange(desc(Count)) %>%               # Change column names and value                                                 displays for more legible table
  rename('Reported Stop Reason' = reason, 
         '# of Stops' = Count, 
         '% of All Stops' = Percent) %>%
     mutate(`% of All Stops` = sprintf("%.2f%%", `% of All Stops`))

##Flextable for counts and rates of stop reasons##
  flextable(count_ois_reason) %>% 
  set_caption('Reasons for Officer-Initiated Stops by Fresno PD (2022)') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header")
```

# Traffic Stops {#traffic}

## Traffic stops by race and gender

```{r}


```

## Count and rate of traffic stops by stop-type

Fresno PD made close to __4,000 traffic stops of moving vehicles in 2022__, which represented more than three-quarters of their total stops for traffic violations.

```{r}

# JZ code chunk for prep

### Create traffic violation universe at person level

traffic<-person%>%
  mutate(person_number=as.character(person_number))%>%
  left_join(stops)%>%
  left_join(person_reason, by =c("stop_id","person_number"))%>%
  filter(call_for_service==0 & reason=='Traffic violation')%>% # keep only officer-initiated stops and traffic violations
  select(stop_id, person_number, reason, g_full, reason, traffic_violation_type, rfs_traffic_violation_type.x, rfs_traffic_violation_code.x )
 
# remove the .x from colunm names

names(traffic) <- gsub(x = names(traffic), pattern = "\\.x", replacement = "")  

```

```{r}

# Total count and rates of traffic stops by each traffic stop type: 1 Moving; 2 Equipment; 3 Nonmoving; Blank. 

#Denominator is out of all officer-initiated traffic stops. 

##Filter out non-traffic violation stops##
tv_reason <- ois_reason %>%
  filter(reason == "Traffic violation")

count_tv_reason <- tv_reason %>%
group_by(traffic_violation_type) %>%
summarise(Count = n(), .groups = 'drop') %>%
mutate(Percent = Count/sum(Count) * 100)

##Create df with count and rates for different traffic stop types##
count_tv_reason <- tv_reason %>%
group_by(traffic_violation_type) %>%
summarise(Count = n(), .groups = 'drop') %>%
mutate(Percent = Count/sum(Count) * 100)

##Create bar chart to visualize counts and rates##
ggplot(count_tv_reason, aes(x = traffic_violation_type, y = Percent, fill = traffic_violation_type)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_manual(values = c("#1B4F72", "#21618C", "#2874A6")) +
  geom_text(
    aes(label = case_when(
      traffic_violation_type == "Equipment" ~ paste(Count, "stops (15%)"),
      traffic_violation_type == "Moving" ~ paste(Count, "stops (77%)"),
      traffic_violation_type == "Non-moving" ~ paste(Count, "stops (8%)")
    )),
    vjust = 1.2, color = "white", size = 4) +
  labs(
    title = "Fresno PD Traffic Violation Stops by Type (2022)",
    x = "Traffic Violation Type",
    y = "% of All Stops for Traffic Violations") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 2,
                               size = 12,
                               margin = margin(t = 2)),
    axis.text.y = element_text(size = 12),
    legend.position = "none") +
  scale_y_continuous(limits = c(0, 100))

```

### By race and gender

```{r}



```

## Stop reasons for equipment/non-moving traffic stops

Over 50% of the non-moving or equipment-related traffic citations issued by Fresno PD in 2022 were for vehicles with obstructed windows or improper registration.

```{r}

# This can be a table looking at the top 50 citations within non-moving/equipment traffic stop types. Denominator is non-moving/equipment traffic stops

# Use table 'rel_persons_reason' and the column 'rfs_traffic_violation_code.' You can look up the citation codes here: "W:\Project\ECI\Fresno RIPA\Data\sdcs-look-up-table-2023.v2.xlsx"  

##Filter out moving traffic stops from data set##
tv_nonmove_reason <- tv_reason %>%
  filter(traffic_violation_type != "Moving")

##Create data frame with counts/rates for 50 most frequent citations##
tv_citation_count <- tv_nonmove_reason %>% 
  group_by(rfs_traffic_violation_code) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
  arrange(desc(Count))

##Create data frame for table visualization with top 10 citations##
tv_citation_flex <- tv_citation_count[1:10, ] %>%
  mutate('Traffic Violation' = case_when(
    rfs_traffic_violation_code == "54571" ~ "Obstructed window/mirrors", 
    rfs_traffic_violation_code == "54657" ~ "Unregistered vehicle",
    rfs_traffic_violation_code == "54644" ~ "License plates improperly displayed",
    rfs_traffic_violation_code == "54099" ~ "Unregistered vehicle in public parking facility",
    rfs_traffic_violation_code == "54109" ~ "Improper vehicle lighting",
    rfs_traffic_violation_code == "54168" ~ "Expired registration",
    rfs_traffic_violation_code == "54116" ~ "Inadequate mufflers",
    rfs_traffic_violation_code == "54141" ~ "Improper bicycle lighting",
    rfs_traffic_violation_code == "54110" ~ "License plate not illuminated",
    rfs_traffic_violation_code == "54191" ~ "Driving without headlights",)) %>% #Adding descriptions of violation indicated by citation code 
  select(rfs_traffic_violation_code, 'Traffic Violation', Count, Percent) %>% #Re-ordering columns
  rename(
    `% of Total Equipment/Non-moving Traffic Violations` = Percent,
    `# of Times Cited` = Count) %>% # Renaming columns to serve as better table headers
  mutate(`% of Total Equipment/Non-moving Traffic Violations` = sprintf("%.2f%%", `% of Total Equipment/Non-moving Traffic Violations`)) %>% #Improving display of percentages for table
  select(2:4) # Hiding citation codes for table
  
##Create Flex table##
  flextable(tv_citation_flex) %>% 
  set_caption('Fresno PD Equipment and Non-moving Traffic Citations Issued (2022)') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header")
  

```

### By race and gender

```{r}



```


## Count and rate of traffic stops by result of stop

Across all three types of officer-initiated traffic stops (Equipment, Moving, Non-moving), a __citation for infraction__ is the most common stop result, while a __Warning verbal or written__ is within the top three most common stop results across all traffic stops. 

```{r}

# join to person-level traffic universe and analyze

df<-traffic%>%
  left_join(person_result)%>%
  group_by(traffic_violation_type)%>%
  mutate(total=n())%>%
  group_by(traffic_violation_type, stop_result_simple)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  select(traffic_violation_type, stop_result_simple, total, count,rate)%>%
  arrange(traffic_violation_type, -rate)%>%
  group_by(traffic_violation_type)%>%
   slice(1:3)

## ggplot?-----------
  

ggplot(df, aes(x = stop_result_simple, y = rate))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(rate,1), "%")), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size = 3,
          color = "white")+ 
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 10))+
  labs(title = "Most Officer-Initiated Traffic Stops Result in a Citation", 
       subtitle = "Top three most common stop results for officer-initiated traffic stops by traffic-stop type",
       x = "", #labels to visual
       y = "") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
  facet_grid(. ~ traffic_violation_type)


#create and style flextable-----------

# names(df)<-tools::toTitleCase(gsub("_"," ",names(df))) # clean up column names for table
# 
#   flextable(df) %>%
# colformat_double(j = c("Rate"), digits = 1)%>%
#   set_caption('Top 3 Results of Officer-Initiated Traffic Stops by Traffic Stop Type') %>%
#   theme_vanilla() %>%
#   width(j=2,2,unit="in")
#   

  

```


### Most common citations that resulted from traffic stop

```{r}

# Total count/rate of each citation out of all traffic stops

# read in traffic citations table at person level
citation_result<-dbGetQuery(con, "SELECT * FROM rel_persons_citations")

# read in offense codes
codes<-dbGetQuery(con, "SELECT * FROM cadoj_ripa_offense_codes_2023")

# join to our traffic universe 

df<-traffic%>%
  left_join(citation_result%>%
              mutate(person_number=as.character(person_number)))

# analyze

df<-df%>%
  select(offense_code)%>%
  mutate(total=n())%>%
  group_by(offense_code)%>%
mutate(count=n(),
       rate=count/total*100)%>%
  slice(1)%>%
  arrange(-rate)%>%
  head(7)%>%
  left_join(codes)%>% # join additional info on offense codes
select(1,6,8,2,3,4)


#create and style flextable

names(df)<-tools::toTitleCase(gsub("_"," ",names(df))) # clean up column names for table

df<-df%>%
  rename("Statute"="Statute Literal 25")

  flextable(df) %>%
colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Most Common Citations that resulted from an Officer-Initiated Traffic Stop') %>%
  theme_vanilla() %>%
  width(j=3,2.5,unit="in")


```

#### By race and gender

```{r}



```

## Traffic stops that result in a citation for driving without a license

The Fresno Police Department only stopped 8 people in 2022 for driving without a license.

```{r}

# Calculate count of traffic stops that result with a citation for driving without a license. You can look up the citation codes here: "W:\Project\ECI\Fresno RIPA\Data\sdcs-look-up-table-2023.v2.xlsx"

##Get count for how many citations there were for driving w/o license##
noDL_count <- tv_reason %>%
  filter(                         #All citation codes for driving w/o license
    rfs_traffic_violation_code %in% c(42127, 54107, 54113, 54396, 54458)) %>%
  summarise(count = n())
print(noDL_count)

```

### By race and gender

```{r}



```

# Stop Results 

## Over-all rate and count of stops by stop result

```{r}

# Total count and rates of officer-initiated stops by stop result Use officer-initiated stops is the denominator. For this use tables: rel_stops & rel_stops_result

# Feel free to visualize as a bar graph, table, or whatever you think works best!



```


## Stops resulting in use of force

Out of all officer-initiated stops made by Fresno PD in 2022, 99.7% of stops were indicated as having no instance of any use of force (5,043 total stops) while 0.33% of stops were indicated in the data as having instances of use of force (17 stops). All officer-initiated incidents of use of force inflicted by Fresno PD in 2022 occurred during __traffic stops__. 

```{r}

# Create universe for use of force analysis: person and stop level data joined together and filtered for officer-initiated stops

uof<-person%>%
  mutate(person_number=as.character(person_number))%>%
  left_join(stops)%>%left_join(actions)%>%
    filter(call_for_service==0)

# Analysis

df<-uof%>%
  mutate(total=n())%>%
  group_by(use_of_force)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  select(use_of_force, total, count, rate)


```

```{r}

df<-uof%>%
  left_join(reason)%>%
  group_by(use_of_force)%>%
    mutate(total=n())%>%
  group_by(use_of_force, stop_reason_simple)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  select(use_of_force, stop_reason_simple, total, count, rate)



```

### By race and gender

Fresno PD disproportionately inflicted use of force towards people they perceived as Latinx men in 2022. 

```{r, include=FALSE}

df_nh<-uof%>%
  left_join(race)%>%
  group_by(use_of_force)%>%
    mutate(total=n())%>%
  group_by(nh_race, use_of_force)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  filter(use_of_force==1)%>%
  select(nh_race, use_of_force, total, count, rate)%>%
  arrange(-rate)

df_gender<-uof%>%
    left_join(race)%>%
  group_by(use_of_force)%>%
    mutate(total=n())%>%
  group_by(nh_race, g_full, use_of_force)%>%
  mutate(count=n(),
         rate=count/total*100)%>%
  slice(1)%>%
  filter(use_of_force==1)%>%
  select(nh_race, g_full, use_of_force, total, count, rate)%>%
  arrange(nh_race, -rate)

# Format the gender table for visualizing 

df<-df_gender%>%
  mutate(g_full=ifelse(g_full %in% '1', 'Male',
                       ifelse(g_full %in% '2', 'Female',
                              g_full)))%>%
    mutate(nh_race=ifelse(nh_race %in% 'latinx', 'Latinx',
                       ifelse(nh_race %in% 'nh_asian', 'Asian',
                              ifelse(nh_race %in% 'nh_sswana', 'SSWANA',
                              "White"))))%>%
  rename("Perceived Gender"="g_full",
         "Perceived Race"="nh_race")%>%
  ungroup()%>%
  select(-3)

#create and style flextable

names(df)<-tools::toTitleCase(gsub("_"," ",names(df))) # clean up column names for table


  flextable(df) %>%
colformat_double(j = c("Rate"), digits = 1)%>%
  set_caption('Use of Force by Perceived Race and Gender') %>%
  theme_vanilla() %>%
  width(j=3,2.5,unit="in")


  


```

## Stops resulting in a field interview (FI) card

Two officer-initiated stops by Fresno PD in 2022 resulted solely in a field interview card being completed. A total of __four people__ were stopped and given FI cards during an officer-initiated stop. All four FI cards were given to people during __traffic stops__. 

```{r, include=FALSE}

##Create df of all officer-initiated stops w/ stop result variables##
ois_result <- left_join(stops, person_result, by ="stop_id")%>%
  filter(call_for_service ==0) %>%
  select(stop_id, stop_result_simple, stop_result_list, everything())

##Create df to find count and rate of all stop results##
count_ois_result <- ois_result %>%
  group_by(stop_result_simple) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
    arrange(desc(Count)) %>%               # Change column names and value                                                 displays for more legible table
  rename('Recorded Stop Result' = stop_result_simple, 
         `# of Times Recorded` = Count, 
         `% of All Stop Results` = Percent) %>%
     mutate(`% of All Stop Results` = sprintf("%.2f%%", `% of All Stop Results`))

##Table to show result counts and rates of all OIS, with FI result highlighted##
flextable(count_ois_result) %>%
  set_caption('Results of Officer-Initiated Stops by Fresno PD (2022)') %>%
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header") %>%
   bold(i = 8, bold = TRUE, part = "body") %>%
  color(i = 8, color = "red", part = "body")


```

```{r, include=FALSE}

##Create df that includes only FI card results and merges in stop reason data##
fi_stop_reason <- left_join(ois_result, reason, by = "stop_id") %>%
  filter(
    stop_result_simple == "field interview card completed" |
    grepl("field interview", stop_result_list, ignore.case = TRUE)) %>%
  select(stop_id, stop_result_simple, stop_reason_simple, stop_result_list, everything())    #Only 4 stops where result was FI, reason for all was TV


```

### By race and gender

Every individual that Fresno PD stopped and completed FI cards for in 2022 was perceived by officers as __Black or Latinx__. Officers also perceived three of these individuals as male and one as female.

```{r, include=FALSE}

##Merge age_race_gender with FI card df##
fi_stop_race_gender <- left_join(fi_stop_reason, age_race_gender_ois, by = "stop_id")   #Df shows 5 individuals who had FI cards filed,
              # 2 Black, 2 Latinx, 1 white.
              # 3 men, 2 women

```

## Stops resulting in referral to US Department of Homeland Security ICE

Fresno PD reported that only one of their stops in 2022 resulted in a person being referred to ICE. The one individual referred to ICE by Fresno PD in 2022 was stopped for a traffic violation.

```{r, include=FALSE}

##count_ois_result shows us 0 under simple results, 
##query to see how many times it is listed under multiple results##
sum(grepl("homeland security", ois_result$stop_result_list, ignore.case = TRUE)) #only 1 total referral to ICE

```

```{r, include=FALSE}
##Create df for one ICE result and merge reason##
ice_reason <- left_join(ois_result, reason, by = "stop_id") %>%
  filter(grepl("homeland security", stop_result_list, ignore.case = TRUE)) %>%
  select(stop_id, stop_result_simple, stop_reason_simple, stop_result_list, everything())

```

### By race and gender

The one individual referred to ICE by Fresno PD in 2022 was perceived by officers as a Latinx male.

```{r, include=FALSE}

##Merge in race and gender variables for one observation##
ice_race_gender <- left_join(ice_reason, age_race_gender_ois, by = "stop_id")

```

## Stops that resulted in a search that resulted in no contraband

### By race and gender


# Time spent

## Time spent on stops by stop reason

## Time spent on stops by stop result





