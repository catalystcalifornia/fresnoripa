---
title: "Fresno RIPA Data Project"
subtitle: "Descriptive Analysis"
author: "Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    toc: yes
    toc_depth: 2
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)


#### Load libraries ####
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
library(flextable)
library(htmlwidgets)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(scales)
library(dplyr)
library(ggplot2)

#add function that better fits the tables to the page    
FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

#### Add database connection ####

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("eci_fresno_ripa")

#### Read in tables you need from postgres ####

# You can use the RDA Data Dictionary to look up column meta data for any of these tables. The dictionary is structured the same as pgadmin: https://www.healthycity.org/rda-dev/pgdatadictionary/ 

stops<-dbGetQuery(con, "SELECT * FROM rel_stops")
results<-dbGetQuery(con, "SELECT * FROM rel_stops_result")
person<-dbGetQuery(con, "SELECT * FROM rel_persons")
person_reason<-dbGetQuery(con, "SELECT * FROM rel_persons_reason")
age<-dbGetQuery(con, "SELECT * FROM rel_age")
race<-dbGetQuery(con, "SELECT * FROM rel_races_recode") ##Updated code. table name on postgres is rel_races_recode





```

Before engaging in a detailed analysis of Fresno PD patrol activity as outlined in the research plan, we created this descriptive analysis to explore overall trends in the Fresno RIPA data. This helps us determine if our expected findings are likely to show up in the data and allows us to identify any trends we did not expect. We include basis tallies on each of the following:

# Stops overview 

## Number and Rate of Officer-Initiated Stops vs. Calls for Service

In 2022, there were a __total of 5,317 police stops__ made by Fresno PD. Of those stops, __5,028 were officer-initiated stops__ and __289 were calls for service.__

In 2022, __94.6%___ of Fresno Police Department stops were officer initiated stops while __only 5.4%__ of stops were calls for service.

```{r}
# Use the 'rel_stops' table to calculate the rate and count of officer initiated stops &  calls for service. 

###CALCULATE TOTAL OFFICER INITIATED STOPS##

count_ois <- stops %>%  
  filter(call_for_service == 0) %>% #filters for Officer-Initiated Stops
    select(stop_id) %>% 
       mutate('Total Officer Initiated Stops' = n()) %>%  
         slice(1) %>% 
           select(-stop_id) 

###CALCULATE CALLS FOR SERVICE TOTAL###

count_cfs <- stops %>%
  filter(call_for_service == 1) %>% 
    select(stop_id) %>% 
      mutate('Total Calls for Service' =n()) %>% 
       slice(1) %>% 
           select(-stop_id) 


### CALCULATE THE RATE OF OFFICER INITIATED STOPS AND CALLS FOR SERVICE###

rate_ois <- stops %>%
  group_by(Stop_Type = call_for_service == 0) %>%
    summarise (percent = 100 * n()/ nrow(stops)) %>%
      mutate(percent =round(percent, digits =1),
        Stop_Type = ifelse(Stop_Type, "Officer Initiated Stop", "Calls for Service")) %>%
  rename('Type' = 'Stop_Type')




###BAR CHART to VISUALIZE RATE OF CALLS FOR SERVICE VS OFFICER INITIATED STOP###

rate_ois <- data.frame( #create df to create a visual later
  Type = c("Officer-Initiated Stop", "Calls for Service"),
  percent = c(94.6, 5.4))

ggplot(rate_ois, aes(x = Type, y = percent, fill = Type))+
  geom_bar(stat = "identity") + #to create barplot
  geom_text(aes(label = paste0(round(percent,1), "%")), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size = 3,
          color = "white")+ 
  labs(title = "Nearly 95% of All Stops Fresno PD Makes Are Not Responding to Community Calls", 
       subtitle = "Percentage of Police Stops by Stop-Type Made by Fresno PD in 2022",
       x = "", #labels to visual
       y = "") +
  scale_fill_manual(values = c("Officer-Initiated Stop"="#362178",
      "Calls for Service" = "#362178" ))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())


```


## Total number of people stopped 

In 2022, Fresno PD stopped a total of __5,060 people__ through Officer-Initiated Stops.

```{r}

# Use the 'rel_persons' AND 'rel_stops' table to calculate total number of people stopped for officer-initiated stops

tot_ois <- left_join(stops, person, by ="stop_id")%>%
  select(call_for_service)%>%
  filter(call_for_service ==0)%>%  
    summarise(count=n())%>%
     ungroup()%>%
       mutate(Total=sum(count))%>%
        rename("Total Number of People Stopped for Officer-Initiated Stops" = count)


```

# Demographics 

## Race

Officer-Initiated Stops by the Fresno Police Department __disproportionately target Latinx residents.__  

```{r}

# Calculate the count and rate of officer-initiated stops by perceived race of person stopped. Use the 'rel_races_recode' table & 'rel_stops'

##CALCULATES COUNT AND RATE FOR OIS BY RACE##

df_race <-  left_join(stops, race, by ="stop_id")%>% #joining tables 
  filter(call_for_service ==0)


df_nh <- df_race %>% ##creates df for nh_race
  select(nh_race)%>% 
  mutate(Total=n())%>%
  group_by(nh_race)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)

df_sswana <- df_race %>% #creates df for sswana
  mutate(Total=n())%>%
  group_by(sswana_flag)%>%
  mutate(Count=n(), Percent = round(Count/Total*100, 1))%>% 
  slice(1)%>%
  arrange(-Percent)%>%
  ungroup()%>%
  select(sswana_label, Total, Count, Percent)
  
final_race <- rbind(df_nh, df_sswana) ##combines nh_race and sswana

final_race <- final_race[-c(4,9),] ##deletes nh_sswana and not_sswana rows



##Recode for nh_race since there was no value for SSWANA in nh_race after deleting the other SSWANA and not_sswana rows##

final_race <- final_race %>%
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
    is.na(nh_race) ~ 'SSWANA', 
    TRUE ~ as.character(nh_race)))
    
                      
                
                        

##ADDING TOTAL NUMBER TO LABEL##

final_race <- final_race%>%
  mutate(label = paste0("Total: ", Count, "\n", round(Percent, 1),"%"))

##VISUALIZATION FOR RATE OF OIS BY RACE ##

ggplot(final_race, aes(x = reorder(Race, -Percent), y = Percent, fill = Race))+
  geom_bar(stat = "identity") + #to create barplot
  geom_text(aes(label = label), #add percentage labels within the bars
          position = position_stack(vjust=0.5), #center percentage within the bar
          size =3,
          color = "white")+ 
  labs(title = "Latinx Individuals Make Up More than Half of Officer-Initiated Stops by Fresno PD",
       subtitle = "Percentage of Officer-Initiated Stops by Race",
       x = "",
       y = "") +
  scale_fill_manual(values = c("#362178", "#362178", "#362178", "#362178", "#362178", "#362178", "#362178","#362178"))+
  theme_bw()+
  theme(plot.title = element_text(hjust =0.5),
        plot.subtitle = element_text(hjust =0.5),
 #sets y-axis labels to be horizontal
      legend.position ="none", #removes legend
      axis.text.y = element_text(angle =0, hjust=1), #Makes y-axis text readable
      axis.text.x = element_text(angle =0, hjust=0.5)) +
  theme(axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=10), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())
#Makes x-axis text readable

```


## Age 


Individuals aged 25-34 experienced the highest rates of Officer-Initiated Stops by Fresno PD in the year 2022.

```{r}

# Calculate the count and rate of officer-initiated stops by age-brackets of person stopped. Use the 'rel_age' table & 'rel_stops'

age_ois<- left_join(age, stops, by ="stop_id")%>% #Joined tables
  filter(call_for_service ==0)%>% #Filtered for OIS
  select(age_group_re)%>% # Selected table of interest
  mutate(Total=n())%>% #To find total number for OIS 
  group_by(age_group_re)%>% # Grouping by recoded age brackets
  mutate(Count=n(), 
         Percent = round(Count/Total*100, 1))%>% #Create percentages and rounding them to tenths place
  slice(1)%>%
  rename('Age' ='age_group_re')%>%
  arrange(-Percent)

#########VISUALIZATION FOR RATE OF OIS BY AGE GROUP########

ggplot(age_ois, aes(x = Age, y=Percent))+
      geom_bar( stat = "identity", fill="#362178") + #create barchart 
  geom_text(aes( label = paste0(round(Percent, digits=1),"%" ), #round to tenths place within barchart label
                 y= Percent),
            vjust = 1.4, 
            size =3,
            color = "white",
             fontface = "bold")+
    labs(title = "Residents Aged 25-34 Account for Nearly 35% of Officer-Initiated Stops by Fresno PD",
         subtitle= "Percentage of Officer-Initiated Stops by Age Group",
      x = "", #labels
  y = "")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
    theme(plot.title = element_text(hjust =0.5, size = 11.5, face="bold"),
          plot.subtitle = element_text(hjust=0.5),
  axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=10), #for label and axis settings
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())


```


## Gender 


In the year 2022, Males account for __nearly 57%__ of Officer-Initiated Stops by Fresno PD.

```{r}

# Calculate people stopped for officer-initiated stop by perceived gender. Use the table 'rel_persons' & 'rel_stops'

  gender_ois<- left_join(person, stops, by ="stop_id")%>% 
  filter(call_for_service ==0)%>%
  select(g_full)%>% 
  mutate(Total=n())%>%
  group_by(g_full)%>%
  mutate(Count=n(), 
         Percent = round(Count/Total*100, 1))%>%
  slice(1)%>%
  arrange(-Percent)

##RECODING FOR GENDER SO THAT X-AXIS DISPLAYS GENDERS INSTEAD OF 1:5##

gender_ois <- gender_ois %>%
  mutate(Gender = recode(g_full,
                         '1'= 'Male',
                         '2' = 'Female',
                         '3' = "Transgender Man/Boy",
                         '4' = 'Transgender Woman/Girl',
                         '5' = 'Gender Nonconforming'))


#########VISUALIZATION FOR OIS BY PERCEIVED GENDER########

ggplot(gender_ois, aes(x= reorder(Gender, -Percent), y= Percent, fill = Gender))+
      geom_bar( stat = "identity", fill="#362178") + #create barchart 
  geom_text(aes(label = paste0(round(Percent, digits=1),"%"), #round to tenths place within barchart label
                 y= Percent),
            vjust = 1.4, 
            size =3,
            color = "white",
             fontface = "bold")+
    labs(title = "Males Account for Nearly 57% of Officer-Initiated Stops",
         subtitle = "Officer-Initiated Stops by Perceived Gender in 2022",
      x = "", #labels
  y = "")+
    scale_x_discrete(labels = wrap_format(10))+
  theme_bw()+
  theme(plot.title = element_text(hjust =0.5),
         plot.subtitle = element_text(hjust=0.5),
  axis.text.x = element_text(angle = 00, vjust = 0.5, hjust=0.5, size=8), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        strip.text = element_text(color = "white", size=10, face="bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())

```


## Race by age 

In all age groups except for 55-64 and 65 and older, Latinx individuals make up nearly 50% or more of the Officer-Initiated Stops by Fresno PD.


In 2022, White individuals within the age groups of 55-64 and 65 and older were the most frequently stopped   during Officer-Initiated Stops by Fresno PD.

```{r}

race_age_ois <- left_join(age, stops, by ="stop_id")%>% 
  left_join(race, by =c("stop_id","person_number"))%>%
  left_join(person%>%mutate(person_number=as.character(person_number)),by =c("stop_id","person_number"))

race_age_ois<-race_age_ois%>%
  filter(call_for_service ==0)%>% #Filtered for OIS
  group_by(age_group_re)%>%
  mutate(total_age=n())%>% #To find total number for each age group
  group_by(age_group_re,nh_race,total_age)%>% # Grouping by all 3 variables and keeping the total per age group recoded
  summarise(Count=n(), # count for the age/race combo
         Percent = round(Count/total_age*100, 1))%>% # percentage for the race combo out of the age category
  slice(1)

##Clean to make Flextable##


race_age_ois <- race_age_ois%>% #Rename column
  rename('Age Group' = age_group_re, 'Total' = total_age)



race_age_ois <- race_age_ois %>% #Recode for race
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
      nh_race == 'nh_sswana' ~ 'SSWANA'))

####Deleting nh_race columns to make a cleaner flextable####
race_age_ois <- race_age_ois[, !names(race_age_ois) %in% c("nh_race")]

#####Reordering columns#####
race_age_ois <- race_age_ois %>% 
  select(`Age Group`, Race, everything())

##Flextable for Age Group, Race##
  flextable(race_age_ois) %>% 
  set_caption('Officer-Initiated Stops in 2022 by Race and Age') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in")

```
## Race by age and gender

Rate and count of perceived gender and age of people stopped within each perceived racial group

In 2022, __Latinx individuals aged 24-35, both Male and Female,__ were the __most frequently stopped__ by Fresno PD during Officer-Initiated Stops.

In 2022, __more than 40% of Latinx males 17 and under__ were stopped by Fresno PD through an Officer-Initiated Stop.

```{r}

# Calculate the distribution of perceived gender/age of people stopped within each perceived racial group. 

age_race_gender_ois<- left_join(age, stops, by ="stop_id")%>% 
  left_join(race, by =c("stop_id","person_number"))%>%
  left_join(person%>%mutate(person_number=as.character(person_number)),by =c("stop_id","person_number"))

age_race_gender_ois_table<-age_race_gender_ois%>%
  filter(call_for_service ==0)%>% #Filtered for OIS
  group_by(age_group_re)%>%
  mutate(total_age=n())%>% #To find total number for each age group
  group_by(age_group_re,nh_race,g_full,total_age)%>% # Grouping by all 3 variables and keeping the total per age group recoded
  summarise(Count=n(), # count for the age/race/gender combo
         Percent = round(Count/total_age*100, 1))%>% # percentage for the race/gender combo out of the age category
  slice(1)

 ##Clean to make Flextable##

age_race_gender_ois_table <- age_race_gender_ois_table %>% #Recode for Race#
  mutate(Race = case_when(
    nh_race == 'latinx' ~ "Latinx", 
    nh_race =='nh_white' ~ 'White',
    nh_race =='nh_black' ~ 'Black',
    nh_race == 'nh_asian' ~ 'Asian',
    nh_race == 'nh_aian' ~ 'AIAN',
    nh_race == 'nh_nhpi' ~ 'NHPI',
    nh_race == 'nh_multiracial' ~ 'Multiracial',
      nh_race == 'nh_sswana' ~ 'SSWANA'))


age_race_gender_ois_table <- age_race_gender_ois_table %>% ##Recode for Gender##
  mutate(Gender = recode(g_full,
                         '1'= 'Male',
                         '2' = 'Female',
                         '3' = "Transgender Man/Boy",
                         '4' = 'Transgender Woman/Girl',
                         '5' = 'Gender Nonconforming'))


age_race_gender_ois_table <- age_race_gender_ois_table%>% ###Renaming columns### 
  rename('Age Group' = age_group_re, 'Total' = total_age )


####Deleting nh_race and  g_full columns to make a cleaner flextable####
age_race_gender_ois_table <- age_race_gender_ois_table[, !names(age_race_gender_ois_table) %in% c("nh_race", "g_full")]

#####Reordering columns#####
age_race_gender_ois_table <- age_race_gender_ois_table%>% 
  select(`Age Group`, Race, Gender, everything())

##Flextable for Age Group, Race, and Gender##
  flextable(age_race_gender_ois_table) %>% 
  set_caption('Officer-Initiated Stops Over Time by Age Group, Race, and Gender') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in")

    
```


# Stop Reasons

## Total counts and rates

The Fresno Police Department makes an overwhelming majority of their officer-initiated stops for traffic violations. In 2022, __Over 99%__ of people stopped by Fresno PD officers were stopped due to a perceived traffic violation.

```{r}

# Total count and rates of officer-initiated stops by stop reason. Officer-initiated stops is the denominator. 

##Create df of all officer-initiated stops w/ stop reason variables##
ois_reason <- left_join(stops, person_reason, by ="stop_id")%>%
  filter(call_for_service ==0) %>%
  select(stop_id, reason, everything())

##Create df with rates and counts by stop reason##
count_ois_reason <- ois_reason %>%
  group_by(reason) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
    arrange(desc(Count)) %>%               # Change column names and value                                                 displays for more legible table
  rename('Reported Stop Reason' = reason, 
         '# of Stops' = Count, 
         '% of All Stops' = Percent) %>%
     mutate(`% of All Stops` = sprintf("%.2f%%", `% of All Stops`))

##Flextable for counts and rates of stop reasons##
  flextable(count_ois_reason) %>% 
  set_caption('Reasons for Officer-Initiated Stops by Fresno PD (2022)') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header")


```


## Traffic stops by type

Fresno PD made close to 4,000 traffic stops of moving vehicles in 2022, which represented more than three-quarters of their total stops for traffic violations.

```{r}

# Total count and rates of traffic stops by each traffic stop type: 1 Moving; 2 Equipment; 3 Nonmoving; Blank. 

#Denominator is out of all officer-initiated traffic stops. 

##Filter out non-traffic violation stops##
tv_reason <- ois_reason %>%
  filter(reason == "Traffic violation")

##Create df with count and rates for different traffic stop types##
ggplot(count_tv_reason, aes(x = traffic_violation_type, y = Percent, fill = traffic_violation_type)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_manual(values = c("#1B4F72", "#21618C", "#2874A6")) +
  geom_text(
    aes(label = case_when(
      traffic_violation_type == "Equipment" ~ paste(Count, "stops (15%)"),
      traffic_violation_type == "Moving" ~ paste(Count, "stops (77%)"),
      traffic_violation_type == "Non-moving" ~ paste(Count, "stops (8%)")
    )),
    vjust = 1.2, color = "white", size = 4) +
  labs(
    title = "Fresno PD Traffic Violation Stops by Type (2022)",
    x = "Traffic Violation Type",
    y = "% of All Stops for Traffic Violations") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 2,
                               size = 12,
                               margin = margin(t = 2)),
    axis.text.y = element_text(size = 12),
    legend.position = "none") +
  scale_y_continuous(limits = c(0, 100))

```


## Citations within equipment/non-moving traffic stops

Over 50% of the non-moving or equipment-related traffic citations issued by Fresno PD in 2022 were for vehicles with obstructed windows or improper registration.

```{r}

# This can be a table looking at the top 50 citations within non-moving/equipment traffic stop types. Denominator is non-moving/equipment traffic stops

# Use table 'rel_persons_reason' and the column 'rfs_traffic_violation_code.' You can look up the citation codes here: "W:\Project\ECI\Fresno RIPA\Data\sdcs-look-up-table-2023.v2.xlsx"  

##Filter out moving traffic stops from data set##
tv_nonmove_reason <- tv_reason %>%
  filter(traffic_violation_type != "Moving")

##Create data frame with counts/rates for 50 most frequent citations##
tv_citation_count <- tv_nonmove_reason %>% 
  group_by(rfs_traffic_violation_code) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  mutate(Percent = Count/sum(Count) * 100) %>%
  arrange(desc(Count))

##Create data frame for table visualization with top 10 citations##
tv_citation_flex <- tv_citation_count[1:10, ] %>%
  mutate('Traffic Violation' = case_when(
    rfs_traffic_violation_code == "54571" ~ "Obstructed window/mirrors", 
    rfs_traffic_violation_code == "54657" ~ "Unregistered vehicle",
    rfs_traffic_violation_code == "54644" ~ "License plates improperly displayed",
    rfs_traffic_violation_code == "54099" ~ "Unregistered vehicle in public parking facility",
    rfs_traffic_violation_code == "54109" ~ "Improper vehicle lighting",
    rfs_traffic_violation_code == "54168" ~ "Expired registration",
    rfs_traffic_violation_code == "54116" ~ "Inadequate mufflers",
    rfs_traffic_violation_code == "54141" ~ "Improper bicycle lighting",
    rfs_traffic_violation_code == "54110" ~ "License plate not illuminated",
    rfs_traffic_violation_code == "54191" ~ "Driving without headlights",)) %>% #Adding discriptions of violation indicated by citation code 
  select(rfs_traffic_violation_code, 'Traffic Violation', Count, Percent) %>% #Re-ordering columns
  rename(
    `% of Total Equipment/Non-moving Traffic Violations` = Percent,
    `# of Times Cited` = Count) %>% # Renaming columns to serve as better table headers
  mutate(`% of Total Equipment/Non-moving Traffic Violations` = sprintf("%.2f%%", `% of Total Equipment/Non-moving Traffic Violations`)) %>% #Improving display of percentages for table
  select(2:4) # Hiding citation codes for table
  
##Create Flex table##
  flextable(tv_citation_flex) %>% 
  set_caption('Fresno PD Equipment and Non-moving Traffic Citations Issued (2022)') %>% 
  theme_vanilla() %>%
  width(width=2,unit="in") %>%
    align(j = 3, align = "right", part = "body") %>%
    align(j = 3, align = "right", part = "header")
    

```

## Traffic stops that result in a citation for driving without a license

The Fresno Police Department only stopped 8 people in 2022 for driving without a license.

```{r}

# Calculate count of traffic stops that result with a citation for driving without a license. You can look up the citation codes here: "W:\Project\ECI\Fresno RIPA\Data\sdcs-look-up-table-2023.v2.xlsx"

##Get count for how many citations there were for driving w/o license##
noDL_count <- tv_reason %>%
  filter(                         #All citation codes for driving w/o license
    rfs_traffic_violation_code %in% c(42127, 54107, 54113, 54396, 54458)) %>%
  summarise(count = n())
print(noDL_count)

```

# Stop Results

## Over-all stops by stop result out of all officer-initiated stops

## Traffic Citations as Stop Result

### Total count/rate of each citation out of all officer-initiated stops


## Use of Force

### Total count/rate out of all officer-initiated stops

### Total count/rate by stop reason

### By race

## Field Interview (FI) Card

### Total count/rate out of all officer-initiated stops

### Total count/rate by stop reason 

### By race


## Referral to US Department of Homeland Security ICE

### Total count/rate out of all officer-initiated stops

### Total count/rate by stop reason

### By race

## Stops with a search that resulted in no contraband [RDA: lower prioritiy]

### Total count/rate out of all officer-initiated stops

# Time spent

## Time spent by stop reason

## Time spent by stop result





