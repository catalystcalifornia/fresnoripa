---
title: ""
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_charts.css"
---
<!-- link to Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

```{r, include=FALSE}

# set up -----------------------------

library(RPostgreSQL)
source("W:\\RDA Team\\R\\credentials_source.R")
# 
# source("W:\\RDA Team\\Packages\\rdaCharts\\HK\\R\\rdaBubblepop.R") # sourcing one of the visual files so I can get color codes

# library(devtools)
 # remotes::install_github("catalystcalifornia/rdaCharts")
library(rdaCharts)
# library(stringr)
library(htmltools) 
# library(htmlwidgets)
# remotes::install_github("jthomasmock/gtExtras")
library(gtExtras)
library(gt)
library(extrafont)
library(usethis)

#connect to postgres

source("W:\\RDA Team\\R\\credentials_source.R")

con <- connect_to_db("eci_fresno_ripa")

# Import data
time <- dbGetQuery(con, "SELECT * FROM data.rel_stop_duration_capped")
stops <- dbGetQuery(con, "SELECT * FROM data.rel_stops")
p_reasons <- dbGetQuery(con, "SELECT * FROM data.rel_persons_reason")
p_races <- dbGetQuery(con, "SELECT * FROM data.rel_races_recode")
races <- dbGetQuery(con, "SELECT * FROM data.rel_stops_race")
p_results<-dbGetQuery(con, "SELECT * FROM data.rel_persons_result")


# Stop universe selection and prep ----
# Get df for officer-initiated stops
ois <- stops %>% filter(call_for_service==0)%>%select(stop_id)

# Filter for people stopped just for traffic violations
traffic <- p_reasons%>%filter(reason=='Traffic violation')%>%select(stop_id,person_number,reason)

# Filter traffic stops just for ois
ois_traffic<-traffic%>%filter(stop_id %in% ois$stop_id)

# join race, result, and capped time
ois_traffic_race<-ois_traffic%>%
  left_join(p_races)%>%select(-race_count_re)%>%
  left_join(time)%>%
  left_join(p_results)

# add bipoc column 
df<-ois_traffic_race%>%
  mutate(bipoc=ifelse(nh_race=='nh_white','White','BIPOC'))

# visualize--------------------------

  ## COLORS ##
  papaya <- "#F25922"
  peridot <- "#CEEA01"
  lavender <- "#CEC4E2"
  meteorite <- "#3A207D"
  ccblue <- "#0860BC"

  black <- "#000000"
  alabaster<-"#FBFBFB"
  gainsboro <- "#DEDEDE"

  # create boxplot dataframe
data<-data_to_boxplot(df,variable=stop_duration_capped,group_var=bipoc, color="#3A207D")

# create caption 

sourcenote<-"Each dot is a person stopped. Catalyst California calculations based on City of Fresno's Police Stop Data (2022), catalystcalifornia.org, 2024. "

methodnote <- "Analysis for all officer-initiated traffic stops made by officers in 2022 that resulted in citation for infraction, warning, or no action. BIPOC (Black, Indigenous, Person of Color) includes all individuals perceived as non-White by officers."

caption_text <- paste("<br>", sourcenote, methodnote)
  
chart<-highchart() %>%
   hc_xAxis(type = "category") %>%
  hc_add_series_list(data)%>%
   hc_add_series(
    data = df,
    type = "scatter",
    hcaes(x = "bipoc", y = "df$stop_duration_capped", group = "bipoc"),
    tooltip = list(pointFormat = "{point.stop_duration_capped:.0f} minutes")
  ) %>%
  hc_plotOptions(scatter = list(
    color = lavender,
    marker = list(
      radius = 2,
      symbol = "circle",
      lineWidth = .5
    )
  ))  %>%
  hc_plotOptions(scatter = list(jitter = list(x = .1, y = 0)))%>%
  hc_yAxis(min=0,max=40)%>%
  hc_title(text = "Fresno PD Spends a Wider Range of Time on Traffic Stops of People of Color") %>%
  hc_caption(text=caption_text)%>%
    hc_subtitle(text = "Time spent in minutes on traffic stops that resulted in citation, warning, or no action")





```

```{r, echo=FALSE}

chart

```
<script>
  widg = document.getElementsByClassName('html-widget'); //find widgets
  for (let i = 0; i < widg.length; i++) { //loop through
    document.getElementsByClassName('highchart')[i].style.width = '100%'; //adjust width
    document.getElementsByClassName('highchart')[i].style.height = '100%'; //adjust height
  }
</script>