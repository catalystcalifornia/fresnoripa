---
title: ""
output:
  html_document:
    css: "W:\\RDA Team\\R\\fbhc_brandguide.css"
---
<!-- link to Adobe Fonts (Source Serif Pro, Montserrat, Open Sans) -->
<link rel="stylesheet" href="https://use.typekit.net/kjp5mnx.css">

```{r, include=FALSE}

# set up -----------------------------
library(RPostgreSQL)
library(devtools)
remotes::install_github("catalystcalifornia/rdaCharts", upgrade="never") 
library(rdaCharts)
library(stringr)
library(htmltools) 

#connect to postgres
source("W:\\RDA Team\\R\\credentials_source.R")

con <- connect_to_db("eci_fresno_ripa")

# pull analysis table for visualizing
df<-dbGetQuery(con, "SELECT * FROM report_traffic_result_race") %>%
  mutate(stop_result_simple = str_to_title(stop_result_simple)) %>%
  mutate(race_label=
           case_when(race == "latinx" ~ "Latinx",
                     race == "nh_aian" ~ "AIAN NH",
                     race == "nh_black" ~ "Black",
                     race == "nh_multiracial" ~ "Multiracial",
                     race == "nh_nhpi" ~ "NHPI NH",
                     race == "nh_sswana" ~ "SSWANA NH",
                     race == "nh_white" ~ "White",
                     race == "aian_aoic" ~ "AIAN",
                     race == "nhpi_aoic" ~ "NHPI",
                     race == "sswana_aoic" ~ "SWANA/SA",
                     race == 'nh_asian' ~ "Asian", 
                     .default = race)) %>%
  filter(race!="nh_sswana")

# filter dataframes with different denominators to visualize and make decision on which embed to use for report
df_race<-df %>%
  filter(denom=="traffic_stop_race") %>%
  filter(race!="nh_nhpi" & race != "nh_aian") %>%
  filter(stop_result_simple=="Citation For Infraction")

```

```{r, include=FALSE}
# Set up embed info------------------
# create caption 
sourcenote<-"Catalyst California's calculations based on City of Fresno's Police Stop Data (2022), catalystcalifornia.org, 2024. "

methodnote <- "Analysis for all officer-initiated traffic stops made by officers in 2022 that resulted in a citation for infraction. Less than 10 people Fresno PD perceived as NHPI or AIAN were stopped for traffic violations. For data masking purposes the data for these groups is suppressed from this chart."

racenote <- "Race/ethnicity: AIAN=American Indian or Alaska Native, NHPI=Native Hawaiian or Pacific Islander, SWANA/SA=Southwest Asian (Middle Eastern) or North African, or South Asian."

caption_text <- paste("<br>", sourcenote, methodnote, racenote)

# create tooltip text
tooltip_text <- "Out of 100 people Fresno PD stopped and perceived as <b>{point.race_label}</b> in officer-initiated traffic stops,  <b>{point.rate:.1f}%</b> of them were given a <b>{point.stop_result_simple}</b> as a result of the stop, or a total of <b>{point.count:.1f}</b> people."

# visualize t--------------------------
chart_race<-rdaBubblepop(
  df_race,
  "race_label",
  "rate",
  "count",
  theme="theme_fbhc",
  title = "The Majority of Traffic Stops made by Fresno PD Result in a Citation",
  subtitle = "Percent of officer-initiated traffic stops resulting in a citation by perceived race",
  tooltip_text = tooltip_text,
  caption = caption_text,
  export_data_label = list(pointFormat='{point.rate:.1f}%') 
)

```

```{r, echo=FALSE}

chart_race

```
<script>
  widg = document.getElementsByClassName('html-widget'); //find widgets
  for (let i = 0; i < widg.length; i++) { //loop through
    document.getElementsByClassName('highchart')[i].style.width = '100%'; //adjust width
    document.getElementsByClassName('highchart')[i].style.height = '100%'; //adjust height
  }
</script>